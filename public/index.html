<script>
const BASE = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1' 
  ? 'https://captain.sapimu.au' 
  : '/api';

const TOKEN_DEFAULT="53d25de32c37b0fcd2b14a9f834050493cc044d5039b5aff3283da73a8ef761b";
const CACHE_KEY="sapimu_cache_v5";
const LANGS=[{c:"id",n:"Indonesian"},{c:"en",n:"English"},{c:"th",n:"Thai"},{c:"vi",n:"Vietnamese"},{c:"pt",n:"Portuguese"},{c:"es",n:"Spanish"},{c:"ja",n:"Japanese"},{c:"ko",n:"Korean"},{c:"zh",n:"Chinese"},{c:"ar",n:"Arabic"},{c:"fr",n:"French"},{c:"de",n:"German"}];

let cache={ids:{},chapters:{}};
let failedPlatforms=[];

function loadCache(){
  try{const s=localStorage.getItem(CACHE_KEY);if(s){cache=JSON.parse(s);}}catch(e){}
}
function saveCache(){
  try{localStorage.setItem(CACHE_KEY,JSON.stringify(cache));}catch(e){}
}

const P={
bilitv:{n:"BiliTV",l:"/api/v1/home",id:"id",t:"title",pa:"dramas",ep:[
{m:"GET",p:"/api/v1/languages",d:"Languages",ty:"meta"},
{m:"GET",p:"/api/v1/home",d:"Home",ty:"list"},
{m:"GET",p:"/api/v1/search",d:"Search",ty:"list",q:{q:"Keyword"}},
{m:"GET",p:"/api/v1/recommend",d:"Recommended",ty:"list"},
{m:"GET",p:"/api/v1/dramas",d:"Dramas",ty:"list"},
{m:"GET",p:"/api/v1/drama/:id",d:"Detail",ty:"detail",pr:{id:1}},
{m:"GET",p:"/api/v1/drama/:id/episode/:ep",d:"Episode",ty:"video",pr:{id:1,ep:1}}
]},
cashdrama:{n:"CashDrama",l:"/api/v1/home",id:"id",t:"name",pa:"data.list",ep:[
{m:"GET",p:"/api/v1/languages",d:"Languages",ty:"meta"},
{m:"GET",p:"/api/v1/home",d:"Home",ty:"list"},
{m:"GET",p:"/api/v1/blocks",d:"Blocks",ty:"list"},
{m:"GET",p:"/api/v1/search",d:"Search",ty:"list",q:{q:"Keyword"}},
{m:"GET",p:"/api/v1/drama/:vid",d:"Detail",ty:"detail",pr:{vid:1}},
{m:"GET",p:"/api/v1/drama/:vid/episodes",d:"Episodes",ty:"list",pr:{vid:1}},
{m:"GET",p:"/api/v1/play/:vid/:ep",d:"Play",ty:"video",pr:{vid:1,ep:1}}
]},
dotdrama:{n:"DotDrama",l:"/api/v1/dramas",id:"dcup",t:"title",pa:"dgiv.lint",ep:[
{m:"GET",p:"/api/v1/dramas",d:"Dramas",ty:"list"},
{m:"GET",p:"/api/v1/collections",d:"Collections",ty:"list"},
{m:"GET",p:"/api/v1/categories",d:"Categories",ty:"list"},
{m:"GET",p:"/api/v1/dramas/:id",d:"Detail",ty:"detail",pr:{id:1}}
]},
dramabite:{n:"DramaBite",l:"/api/v1/dramas",id:"id",t:"title",pa:"data",ep:[
{m:"GET",p:"/api/v1/languages",d:"Languages",ty:"meta"},
{m:"GET",p:"/api/v1/dramas",d:"Dramas",ty:"list"},
{m:"GET",p:"/api/v1/foryou",d:"For You",ty:"list"},
{m:"GET",p:"/api/v1/hot",d:"Hot",ty:"list"},
{m:"GET",p:"/api/v1/search",d:"Search",ty:"list",q:{q:"Keyword"}},
{m:"GET",p:"/api/v1/drama/:id",d:"Detail",ty:"detail",pr:{id:1}},
{m:"GET",p:"/api/v1/drama/:id/episode/:ep",d:"Episode",ty:"video",pr:{id:1,ep:1}}
]},
dramabox:{n:"DramaBox",l:"/api/v1/foryou/1",id:"book_id",t:"name",pa:"data.list",ep:[
{m:"GET",p:"/api/v1/foryou/:page",d:"For You",ty:"list",pr:{page:0}},
{m:"GET",p:"/api/v1/new/:page",d:"New",ty:"list",pr:{page:0}},
{m:"GET",p:"/api/v1/rank/:type",d:"Ranking",ty:"list",pr:{type:0}},
{m:"GET",p:"/api/v1/search/:keyword/:page",d:"Search",ty:"list",pr:{keyword:0,page:0}},
{m:"GET",p:"/api/v1/chapters/:bookId",d:"Chapters",ty:"list",pr:{bookId:1}},
{m:"GET",p:"/api/v1/watch/:bookId/:index",d:"Watch",ty:"video",pr:{bookId:1,index:1}}
]},
dramadash:{n:"DramaDash",l:"/api/v1/home",id:"id",t:"name",pa:"data.banner",ep:[
{m:"GET",p:"/api/v1/home",d:"Home",ty:"list"},
{m:"GET",p:"/api/v1/tabs/:id",d:"Tab",ty:"list",pr:{id:0}},
{m:"GET",p:"/api/v1/search/:query",d:"Search",ty:"list",pr:{query:0}},
{m:"GET",p:"/api/v1/drama/:id",d:"Detail",ty:"detail",pr:{id:1}},
{m:"GET",p:"/api/v1/episode/:dramaId/:eps",d:"Episode",ty:"video",pr:{dramaId:1,eps:1}}
]},
dramanow:{n:"DramaNow",l:"/api/v1/series",id:"id",t:"title",pa:"data",ep:[
{m:"GET",p:"/api/v1/languages",d:"Languages",ty:"meta"},
{m:"GET",p:"/api/v1/search",d:"Search",ty:"list",q:{q:"Keyword"}},
{m:"GET",p:"/api/v1/series",d:"Series",ty:"list",q:{id:"Series ID"}},
{m:"GET",p:"/api/v1/video",d:"Video",ty:"video",q:{id:"Video ID"}}
]},
dramanova:{n:"DramaNova",l:"/api/v1/dramas",id:"id",t:"title",pa:"data",ep:[
{m:"GET",p:"/api/v1/languages",d:"Languages",ty:"meta"},
{m:"GET",p:"/api/v1/dramas",d:"Dramas",ty:"list"},
{m:"GET",p:"/api/v1/search",d:"Search",ty:"list",q:{q:"Keyword"}},
{m:"GET",p:"/api/v1/recommend",d:"Recommended",ty:"list"},
{m:"GET",p:"/api/v1/drama/:id",d:"Detail",ty:"detail",pr:{id:1}},
{m:"GET",p:"/api/v1/drama/:id/episode/:ep",d:"Episode",ty:"video",pr:{id:1,ep:1}}
]},
dramapops:{n:"DramaPops",l:"/api/v1/dramas",id:"id",t:"title",pa:"data",ep:[
{m:"GET",p:"/api/v1/languages",d:"Languages",ty:"meta"},
{m:"GET",p:"/api/v1/homepage",d:"Homepage",ty:"list"},
{m:"GET",p:"/api/v1/dramas",d:"Dramas",ty:"list"},
{m:"GET",p:"/api/v1/dramas/trending",d:"Trending",ty:"list"},
{m:"GET",p:"/api/v1/dramas/popular",d:"Popular",ty:"list"},
{m:"GET",p:"/api/v1/search",d:"Search",ty:"list",q:{q:"Keyword"}},
{m:"GET",p:"/api/v1/drama/:id",d:"Detail",ty:"detail",pr:{id:1}},
{m:"GET",p:"/api/v1/drama/:id/episode/:ep/video",d:"Video",ty:"video",pr:{id:1,ep:1}}
]},
dramarush:{n:"DramaRush",l:"/api/v1/tabs/1",id:"id",t:"name",pa:"data",ep:[
{m:"GET",p:"/api/v1/config",d:"Config",ty:"meta"},
{m:"GET",p:"/api/v1/ranking",d:"Ranking",ty:"list"},
{m:"GET",p:"/api/v1/tabs/:id",d:"Tab",ty:"list",pr:{id:0}},
{m:"GET",p:"/api/v1/search/:q",d:"Search",ty:"list",pr:{q:0}},
{m:"GET",p:"/api/v1/drama/:id",d:"Detail",ty:"detail",pr:{id:1}},
{m:"GET",p:"/api/v1/play/:id",d:"Episodes",ty:"list",pr:{id:1}},
{m:"GET",p:"/api/v1/play/:id/:ep",d:"Episode",ty:"video",pr:{id:1,ep:1}}
]},
dramawave:{n:"DramaWave",l:"/api/v1/feed/popular",id:"id",t:"name",pa:"data",ep:[
{m:"GET",p:"/api/v1/languages",d:"Languages",ty:"meta"},
{m:"GET",p:"/api/v1/feed/:tab",d:"Feed",ty:"list",pr:{tab:0}},
{m:"GET",p:"/api/v1/search",d:"Search",ty:"list",q:{q:"Keyword"}},
{m:"GET",p:"/api/v1/search/hot",d:"Hot keywords",ty:"list"},
{m:"GET",p:"/api/v1/dramas/:id",d:"Detail",ty:"detail",pr:{id:1}},
{m:"GET",p:"/api/v1/dramas/:id/play/:ep",d:"Episode",ty:"video",pr:{id:1,ep:1}}
]},
dreamshort:{n:"DreamShort",l:"/discover/sections",id:"bookId",t:"bookName",pa:"data",ep:[
{m:"GET",p:"/discover/sections",d:"Sections",ty:"list",q:{tabId:"Tab ID"}},
{m:"GET",p:"/search/books",d:"Search",ty:"list",q:{keyword:"Keyword"}},
{m:"GET",p:"/book/getBookDetail",d:"Detail",ty:"detail",q:{bookId:"Book ID"}},
{m:"GET",p:"/bookShelf/chapterList",d:"Chapters",ty:"list",q:{bookId:"Book ID"}},
{m:"GET",p:"/book/getChapterDetail",d:"Chapter",ty:"video",q:{bookId:"Book ID",chapterId:"Chapter ID"}}
]},
flickreels:{n:"FlickReels",l:"/api/v1/for-you",id:"playlet_id",t:"name",pa:"data",ep:[
{m:"GET",p:"/api/v1/for-you",d:"For You",ty:"list"},
{m:"GET",p:"/api/v1/hot-rank",d:"Hot",ty:"list"},
{m:"GET",p:"/api/v1/search",d:"Search",ty:"list",q:{q:"Keyword"}},
{m:"GET",p:"/api/v1/navigation",d:"Categories",ty:"list"},
{m:"GET",p:"/api/v1/category/:navId",d:"Category",ty:"list",pr:{navId:0}},
{m:"GET",p:"/api/v1/play/:playletId",d:"Detail",ty:"detail",pr:{playletId:1}},
{m:"GET",p:"/api/v1/chapters/:playletId",d:"Chapters",ty:"list",pr:{playletId:1}},
{m:"GET",p:"/api/v1/stream/:playletId/:chapterNum",d:"Stream",ty:"video",pr:{playletId:1,chapterNum:1}}
]},
flickshort:{n:"FlickShort",l:"/api/v1/home",id:"id",t:"title",pa:"data",ep:[
{m:"GET",p:"/api/v1/languages",d:"Languages",ty:"meta"},
{m:"GET",p:"/api/v1/home",d:"Home",ty:"list"},
{m:"GET",p:"/api/v1/search",d:"Search",ty:"list",q:{q:"Keyword"}},
{m:"GET",p:"/api/v1/recommend",d:"Recommended",ty:"list"},
{m:"GET",p:"/api/v1/drama/:id",d:"Detail",ty:"detail",pr:{id:1}},
{m:"GET",p:"/api/v1/drama/:id/episode/:ep",d:"Episode",ty:"video",pr:{id:1,ep:1}}
]},
flextv:{n:"FlexTV",l:"/api/v1/tabs/popular",id:"id",t:"name",pa:"data.list",ep:[
{m:"GET",p:"/api/v1/languages",d:"Languages",ty:"meta"},
{m:"GET",p:"/api/v1/tabs",d:"Tabs",ty:"list"},
{m:"GET",p:"/api/v1/tabs/:name",d:"Tab content",ty:"list",pr:{name:0}},
{m:"GET",p:"/api/v1/search",d:"Search",ty:"list",q:{q:"Keyword"}},
{m:"GET",p:"/api/v1/series/:id",d:"Detail",ty:"detail",pr:{id:1}},
{m:"GET",p:"/api/v1/series/:id/episodes",d:"Episodes",ty:"list",pr:{id:1}},
{m:"GET",p:"/api/v1/play/:series_id/:section_id",d:"Play",ty:"video",pr:{series_id:1,section_id:1}}
]},
freereels:{n:"FreeReels",l:"/api/v1/popular",id:"id",t:"title",pa:"data",ep:[
{m:"GET",p:"/api/v1/foryou",d:"For You",ty:"list"},
{m:"GET",p:"/api/v1/popular",d:"Popular",ty:"list"},
{m:"GET",p:"/api/v1/new",d:"New",ty:"list"},
{m:"GET",p:"/api/v1/female",d:"Female",ty:"list"},
{m:"GET",p:"/api/v1/male",d:"Male",ty:"list"},
{m:"GET",p:"/api/v1/search",d:"Search",ty:"list",q:{q:"Keyword"}},
{m:"GET",p:"/api/v1/dramas/:id",d:"Detail",ty:"detail",pr:{id:1}},
{m:"GET",p:"/api/v1/dramas/:id/episodes",d:"Episodes",ty:"list",pr:{id:1}},
{m:"GET",p:"/api/v1/dramas/:id/play/:ep",d:"Play",ty:"video",pr:{id:1,ep:1}}
]},
fundrama:{n:"FunDrama",l:"/api/v1/dramas",id:"id",t:"title",pa:"data",ep:[
{m:"GET",p:"/api/v1/languages",d:"Languages",ty:"meta"},
{m:"GET",p:"/api/v1/dramas",d:"Dramas",ty:"list"},
{m:"GET",p:"/api/v1/search",d:"Search",ty:"list",q:{q:"Keyword"}},
{m:"GET",p:"/api/v1/drama/:id",d:"Detail",ty:"detail",pr:{id:1}},
{m:"GET",p:"/api/v1/drama/:id/episodes",d:"Episodes",ty:"list",pr:{id:1}},
{m:"GET",p:"/api/v1/drama/:id/episode/:ep",d:"Episode",ty:"video",pr:{id:1,ep:1}}
]},
goodshort:{n:"GoodShort",l:"/api/v1/home",id:"bookId",t:"bookName",pa:"data.list",ep:[
{m:"GET",p:"/api/v1/home",d:"Home",ty:"list"},
{m:"GET",p:"/api/v1/search",d:"Search",ty:"list",q:{q:"Keyword"}},
{m:"GET",p:"/api/v1/book/:id",d:"Detail",ty:"detail",pr:{id:1}},
{m:"GET",p:"/api/v1/chapters/:bookId",d:"Chapters",ty:"list",pr:{bookId:1}},
{m:"GET",p:"/api/v1/play/:bookId/:chapterId",d:"Play",ty:"video",pr:{bookId:1,chapterId:1}},
{m:"GET",p:"/api/v1/unlock/:bookId",d:"Unlock all",ty:"action",pr:{bookId:1}}
]},
hishort:{n:"HiShort",l:"/api/v1/home",id:"id",t:"title",pa:"data.popular",ep:[
{m:"GET",p:"/api/v1/home",d:"Home",ty:"list"},
{m:"GET",p:"/api/v1/search",d:"Search",ty:"list",q:{q:"Keyword"}},
{m:"GET",p:"/api/v1/drama/:id",d:"Detail",ty:"detail",pr:{id:1}},
{m:"GET",p:"/api/v1/episode/:slug",d:"Episode",ty:"video",pr:{slug:1}}
]},
idrama:{n:"iDrama",l:"/api/v1/popular",id:"id",t:"title",pa:"data",ep:[
{m:"GET",p:"/api/v1/popular",d:"Popular",ty:"list"},
{m:"GET",p:"/api/v1/latest",d:"Latest",ty:"list"},
{m:"GET",p:"/api/v1/search",d:"Search",ty:"list",q:{q:"Keyword"}},
{m:"GET",p:"/api/v1/genres",d:"Genres",ty:"list"},
{m:"GET",p:"/api/v1/genre/:id",d:"Genre",ty:"list",pr:{id:0}},
{m:"GET",p:"/api/v1/drama/:id",d:"Detail",ty:"detail",pr:{id:1}},
{m:"POST",p:"/api/v1/unlock/:dramaId/:start/:end",d:"Unlock",ty:"action",pr:{dramaId:1,start:0,end:0}}
]},
kalostv:{n:"KalosTV",l:"/api/v1/home",id:"id",t:"name",pa:"data",ep:[
{m:"GET",p:"/api/v1/tabs",d:"Tabs",ty:"list"},
{m:"GET",p:"/api/v1/home",d:"Home",ty:"list"},
{m:"GET",p:"/api/v1/foryou",d:"For You",ty:"list"},
{m:"GET",p:"/api/v1/search",d:"Search",ty:"list",q:{q:"Keyword"}},
{m:"GET",p:"/api/v1/video/:id",d:"Detail",ty:"detail",pr:{id:1}},
{m:"GET",p:"/api/v1/video/:id/episodes",d:"Episodes",ty:"list",pr:{id:1}},
{m:"GET",p:"/api/v1/video/:id/episode/:ep",d:"Episode",ty:"video",pr:{id:1,ep:1}},
{m:"GET",p:"/api/v1/rank",d:"Ranking",ty:"list"},
{m:"GET",p:"/api/v1/categories",d:"Categories",ty:"list"},
{m:"GET",p:"/api/v1/tag/:id",d:"Tag",ty:"list",pr:{id:0}}
]},
melolo:{n:"Melolo",l:"/api/v1/bookmall",id:"id",t:"title",pa:"data",ep:[
{m:"GET",p:"/api/v1/languages",d:"Languages",ty:"meta"},
{m:"GET",p:"/api/v1/bookmall",d:"Bookmall",ty:"list"},
{m:"GET",p:"/api/v1/search",d:"Search",ty:"list",q:{q:"Keyword"}},
{m:"GET",p:"/api/v1/series",d:"Series",ty:"detail",q:{id:"Series ID"}},
{m:"GET",p:"/api/v1/video",d:"Video",ty:"video",q:{id:"Video ID"}},
{m:"GET",p:"/api/v1/batch/videos",d:"Batch videos",ty:"video"}
]},
meloshort:{n:"MeloShort",l:"/api/v1/dramas",id:"id",t:"title",pa:"data",ep:[
{m:"GET",p:"/api/v1/dramas",d:"Dramas",ty:"list"},
{m:"GET",p:"/api/v1/dramas/discover",d:"Discover",ty:"list"},
{m:"GET",p:"/api/v1/dramas/top",d:"Top",ty:"list"},
{m:"GET",p:"/api/v1/dramas/search",d:"Search",ty:"list",q:{q:"Keyword"}},
{m:"GET",p:"/api/v1/dramas/:id/episodes",d:"Episodes",ty:"list",pr:{id:1}},
{m:"GET",p:"/api/v1/dramas/:id/episodes/:chapter",d:"Episode",ty:"video",pr:{id:1,chapter:1}}
]},
microdrama:{n:"MicroDrama",l:"/api/v1/dramas",id:"id",t:"title",pa:"data",ep:[
{m:"GET",p:"/api/v1/languages",d:"Languages",ty:"meta"},
{m:"GET",p:"/api/v1/dramas",d:"Dramas",ty:"list"},
{m:"GET",p:"/api/v1/dramas/search",d:"Search",ty:"list",q:{q:"Keyword"}},
{m:"GET",p:"/api/v1/dramas/:id",d:"Detail",ty:"detail",pr:{id:1}}
]},
minutedrama:{n:"MinuteDrama",l:"/api/v1/popular",id:"id",t:"title",pa:"data",ep:[
{m:"GET",p:"/api/v1/popular",d:"Popular",ty:"list"},
{m:"GET",p:"/api/v1/search",d:"Search",ty:"list",q:{q:"Keyword"}},
{m:"GET",p:"/api/v1/videos/:id",d:"Detail",ty:"detail",pr:{id:1}}
]},
mydrama:{n:"MyDrama",l:"/api/v1/series",id:"id",t:"title",pa:"data",ep:[
{m:"GET",p:"/api/v1/languages",d:"Languages",ty:"meta"},
{m:"GET",p:"/api/v1/tags",d:"Tags",ty:"list"},
{m:"GET",p:"/api/v1/series",d:"Series",ty:"list"},
{m:"GET",p:"/api/v1/search",d:"Search",ty:"list",q:{q:"Keyword"}},
{m:"GET",p:"/api/v1/series/:id",d:"Detail",ty:"detail",pr:{id:1}},
{m:"GET",p:"/api/v1/series/:id/episodes",d:"Episodes",ty:"list",pr:{id:1}},
{m:"GET",p:"/api/v1/video/:seriesId/:position",d:"Video",ty:"video",pr:{seriesId:1,position:1}}
]},
netshort:{n:"NetShort",l:"/api/v1/feed/1",id:"id",t:"name",pa:"data.list",ep:[
{m:"GET",p:"/api/v1/languages",d:"Languages",ty:"meta"},
{m:"GET",p:"/api/v1/feed/:page",d:"Feed",ty:"list",pr:{page:0}},
{m:"GET",p:"/api/v1/explore/:page",d:"Explore",ty:"list",pr:{page:0}},
{m:"GET",p:"/api/v1/new/:page",d:"New",ty:"list",pr:{page:0}},
{m:"GET",p:"/api/v1/search/:keyword/:page",d:"Search",ty:"list",pr:{keyword:0,page:0}},
{m:"GET",p:"/api/v1/categories",d:"Categories",ty:"list"},
{m:"GET",p:"/api/v1/detail/:id",d:"Detail",ty:"detail",pr:{id:1}},
{m:"GET",p:"/api/v1/episodes/:id",d:"Episodes",ty:"list",pr:{id:1}},
{m:"GET",p:"/api/v1/episode/:id/:episodeNo",d:"Episode",ty:"video",pr:{id:1,episodeNo:1}}
]},
radreels:{n:"RadReels",l:"/api/v1/home",id:"id",t:"name",pa:"data",ep:[
{m:"GET",p:"/api/v1/home",d:"Home",ty:"list"},
{m:"GET",p:"/api/v1/foryou",d:"For You",ty:"list"},
{m:"GET",p:"/api/v1/ranking",d:"Ranking",ty:"list"},
{m:"GET",p:"/api/v1/tab/:id",d:"Tab",ty:"list",pr:{id:0}},
{m:"GET",p:"/api/v1/search/:query",d:"Search",ty:"list",pr:{query:0}},
{m:"GET",p:"/api/v1/drama/:keyword",d:"Detail",ty:"detail",pr:{keyword:1}},
{m:"GET",p:"/api/v1/episodes/:fakeId",d:"Episodes",ty:"list",pr:{fakeId:1}},
{m:"GET",p:"/api/v1/video/:videoFakeId/:episodicDramaId",d:"Video",ty:"video",pr:{videoFakeId:1,episodicDramaId:1}}
]},
rapidtv:{n:"RapidTV",l:"/api/v1/dramas",id:"id",t:"title",pa:"data",ep:[
{m:"GET",p:"/api/v1/dramas",d:"Dramas",ty:"list"},
{m:"GET",p:"/api/v1/search",d:"Search",ty:"list",q:{q:"Keyword"}},
{m:"GET",p:"/api/v1/dramas/:id",d:"Detail",ty:"detail",pr:{id:1}},
{m:"GET",p:"/api/v1/dramas/:id/episodes",d:"Episodes",ty:"list",pr:{id:1}}
]},
reelife:{n:"Reelife",l:"/api/v1/dramas",id:"id",t:"title",pa:"data",ep:[
{m:"GET",p:"/api/v1/dramas",d:"Dramas",ty:"list"},
{m:"GET",p:"/api/v1/foryou",d:"For You",ty:"list"},
{m:"GET",p:"/api/v1/search",d:"Search",ty:"list",q:{q:"Keyword"}},
{m:"GET",p:"/api/v1/dramas/:id",d:"Detail",ty:"detail",pr:{id:1}},
{m:"GET",p:"/api/v1/dramas/:id/chapters",d:"Chapters",ty:"list",pr:{id:1}},
{m:"GET",p:"/api/v1/dramas/:bookId/episodes/:chapterId",d:"Episode",ty:"video",pr:{bookId:1,chapterId:1}}
]},
reelshort:{n:"ReelShort",l:"/api/v1/foryou",id:"id",t:"name",pa:"data.hall_list",ep:[
{m:"GET",p:"/api/v1/foryou",d:"For You",ty:"list"},
{m:"GET",p:"/api/v1/new",d:"New",ty:"list"},
{m:"GET",p:"/api/v1/completed",d:"Completed",ty:"list"},
{m:"GET",p:"/api/v1/romance",d:"Romance",ty:"list"},
{m:"GET",p:"/api/v1/drama",d:"Drama",ty:"list"},
{m:"GET",p:"/api/v1/leaderboard",d:"Leaderboard",ty:"list"},
{m:"GET",p:"/api/v1/search",d:"Search",ty:"list",q:{q:"Keyword"}},
{m:"GET",p:"/api/v1/feed/:tabId",d:"Feed",ty:"list",pr:{tabId:0}},
{m:"GET",p:"/api/v1/book/:id",d:"Detail",ty:"detail",pr:{id:1}},
{m:"GET",p:"/api/v1/book/:id/chapters",d:"Chapters",ty:"list",pr:{id:1}},
{m:"GET",p:"/api/v1/book/:id/chapter/:chapterId/video",d:"Video",ty:"video",pr:{id:1,chapterId:1}}
]},
shorten:{n:"Shorten",l:"/api/v1/explore",id:"slug",t:"title",pa:"data",ep:[
{m:"GET",p:"/api/v1/editors",d:"Editors",ty:"list"},
{m:"GET",p:"/api/v1/exclusive",d:"Exclusive",ty:"list"},
{m:"GET",p:"/api/v1/dubbed",d:"Dubbed",ty:"list"},
{m:"GET",p:"/api/v1/releases",d:"Releases",ty:"list"},
{m:"GET",p:"/api/v1/categories",d:"Categories",ty:"list"},
{m:"GET",p:"/api/v1/explore",d:"Explore",ty:"list"},
{m:"GET",p:"/api/v1/series/:slug",d:"Series",ty:"detail",pr:{slug:1}}
]},
shortbox:{n:"ShortBox",l:"/api/list",id:"id",t:"name",pa:"data.list",ep:[
{m:"GET",p:"/api/languages",d:"Languages",ty:"meta"},
{m:"GET",p:"/api/categories",d:"Categories",ty:"list"},
{m:"GET",p:"/api/list",d:"List",ty:"list",q:{sort_type:"Sort"}},
{m:"GET",p:"/api/new-list",d:"New",ty:"list"},
{m:"GET",p:"/api/hot-search",d:"Hot",ty:"list"},
{m:"GET",p:"/api/search",d:"Search",ty:"list",q:{keyword:"Keyword"}},
{m:"GET",p:"/api/detail/:id",d:"Detail",ty:"detail",pr:{id:1}},
{m:"GET",p:"/api/episodes/:id",d:"Episodes",ty:"list",pr:{id:1}}
]},
shortmax:{n:"ShortMax",l:"/api/v1/home",id:"code",t:"name",pa:"data",ep:[
{m:"GET",p:"/api/v1/languages",d:"Languages",ty:"meta"},
{m:"GET",p:"/api/v1/home",d:"Home",ty:"list"},
{m:"GET",p:"/api/v1/foryou",d:"For You",ty:"list"},
{m:"GET",p:"/api/v1/feed/recommend",d:"Recommended",ty:"list"},
{m:"GET",p:"/api/v1/feed/new",d:"New",ty:"list"},
{m:"GET",p:"/api/v1/feed/ranked",d:"Ranked",ty:"list"},
{m:"GET",p:"/api/v1/search",d:"Search",ty:"list",q:{q:"Keyword"}},
{m:"GET",p:"/api/v1/detail/:code",d:"Detail",ty:"detail",pr:{code:1}},
{m:"GET",p:"/api/v1/play/:code",d:"Play",ty:"video",pr:{code:1}}
]},
shortsky:{n:"ShortSky",l:"/api/home",id:"id",t:"name",pa:"data",ep:[
{m:"GET",p:"/api/languages",d:"Languages",ty:"meta"},
{m:"GET",p:"/api/home",d:"Home",ty:"list"},
{m:"GET",p:"/api/recommend",d:"Recommended",ty:"list"},
{m:"GET",p:"/api/search",d:"Search",ty:"list",q:{q:"Keyword"}},
{m:"GET",p:"/api/drama/:id",d:"Detail",ty:"detail",pr:{id:1}},
{m:"GET",p:"/api/drama/:id/episode/:ep",d:"Episode",ty:"video",pr:{id:1,ep:1}}
]},
shotshort:{n:"ShotShort",l:"/api/popular",id:"book_id",t:"name",pa:"data",ep:[
{m:"GET",p:"/api/languages",d:"Languages",ty:"meta"},
{m:"GET",p:"/api/popular",d:"Popular",ty:"list"},
{m:"GET",p:"/api/search",d:"Search",ty:"list",q:{q:"Keyword"}},
{m:"GET",p:"/api/category/list",d:"Categories",ty:"list"},
{m:"GET",p:"/api/category",d:"Category",ty:"list",q:{name:"Name"}},
{m:"GET",p:"/api/book/:id",d:"Detail",ty:"detail",pr:{id:1}},
{m:"GET",p:"/api/book/:id/episodes",d:"Episodes",ty:"list",pr:{id:1}},
{m:"GET",p:"/api/book/:bookId/chapter/:chapterId",d:"Chapter",ty:"video",pr:{bookId:1,chapterId:1}}
]},
snackshort:{n:"SnackShort",l:"/api/v1/home",id:"bookId",t:"bookName",pa:"data.data",ep:[
{m:"GET",p:"/api/v1/home",d:"Home",ty:"list"},
{m:"GET",p:"/api/v1/tabs",d:"Tabs",ty:"list"},
{m:"GET",p:"/api/v1/browsing",d:"Browse",ty:"list"},
{m:"GET",p:"/api/v1/search",d:"Search",ty:"list",q:{q:"Keyword"}},
{m:"GET",p:"/api/v1/book/:bookId",d:"Detail",ty:"detail",pr:{bookId:1}},
{m:"GET",p:"/api/v1/book/:bookId/chapters",d:"Chapters",ty:"list",pr:{bookId:1}},
{m:"GET",p:"/api/v1/book/:bookId/episode/:chapterId",d:"Episode",ty:"video",pr:{bookId:1,chapterId:1}}
]},
sodareels:{n:"SodaReels",l:"/api/v1/home",id:"id",t:"title",pa:"data.dinsur.lconne",ep:[
{m:"GET",p:"/api/v1/home",d:"Home",ty:"list"},
{m:"GET",p:"/api/v1/search",d:"Search",ty:"list",q:{q:"Keyword"}},
{m:"GET",p:"/api/v1/category",d:"Categories",ty:"list"},
{m:"GET",p:"/api/v1/info/:id",d:"Info",ty:"detail",pr:{id:1}},
{m:"GET",p:"/api/v1/drama/:id",d:"Drama",ty:"detail",pr:{id:1}},
{m:"GET",p:"/api/v1/episodes",d:"Episodes",ty:"list",q:{id:"Drama ID"}}
]},
stardusttv:{n:"StardustTV",l:"/api/v1/homepage",id:"id",t:"name",pa:"data",ep:[
{m:"GET",p:"/api/v1/languages",d:"Languages",ty:"meta"},
{m:"GET",p:"/api/v1/homepage",d:"Homepage",ty:"list"},
{m:"GET",p:"/api/v1/search",d:"Search",ty:"list",q:{q:"Keyword"}},
{m:"GET",p:"/api/v1/video/:slug/:id",d:"Detail",ty:"detail",pr:{slug:1,id:1}},
{m:"GET",p:"/api/v1/video/:slug/:id/episode/:episode",d:"Episode",ty:"video",pr:{slug:1,id:1,episode:1}}
]},
starshort:{n:"StarShort",l:"/api/v1/dramas",id:"id",t:"title",pa:"data",ep:[
{m:"GET",p:"/api/v1/languages",d:"Languages",ty:"meta"},
{m:"GET",p:"/api/v1/dramas",d:"Popular",ty:"list"},
{m:"GET",p:"/api/v1/dramas/new",d:"New",ty:"list"},
{m:"GET",p:"/api/v1/dramas/search",d:"Search",ty:"list",q:{q:"Keyword"}},
{m:"GET",p:"/api/v1/dramas/:dramaId",d:"Detail",ty:"detail",pr:{dramaId:1}},
{m:"GET",p:"/api/v1/dramas/:dramaId/episodes",d:"Episodes",ty:"list",pr:{dramaId:1}},
{m:"GET",p:"/api/v1/dramas/:dramaId/episodes/:epNum",d:"Episode",ty:"video",pr:{dramaId:1,epNum:1}}
]},
velolo:{n:"Velolo",l:"/hot",id:"id",t:"name",pa:"data",ep:[
{m:"GET",p:"/languages",d:"Languages",ty:"meta"},
{m:"GET",p:"/hot",d:"Hot",ty:"list"},
{m:"GET",p:"/new",d:"New",ty:"list"},
{m:"GET",p:"/labels",d:"Labels",ty:"list"},
{m:"GET",p:"/dramas",d:"Dramas",ty:"list",q:{keyword:"Search",labelId:"Label"}},
{m:"GET",p:"/detail/:id",d:"Detail",ty:"detail",pr:{id:1}}
]},
vigloo:{n:"Vigloo",l:"/api/v1/tabs",id:"id",t:"name",pa:"data",ep:[
{m:"GET",p:"/api/v1/languages",d:"Languages",ty:"meta"},
{m:"GET",p:"/api/v1/tabs",d:"Tabs",ty:"list"},
{m:"GET",p:"/api/v1/tabs/:id",d:"Tab",ty:"list",pr:{id:0}},
{m:"GET",p:"/api/v1/browse",d:"Browse",ty:"list"},
{m:"GET",p:"/api/v1/search",d:"Search",ty:"list",q:{q:"Keyword"}},
{m:"GET",p:"/api/v1/rank",d:"Ranking",ty:"list"},
{m:"GET",p:"/api/v1/genres",d:"Genres",ty:"list"},
{m:"GET",p:"/api/v1/drama/:id",d:"Detail",ty:"detail",pr:{id:1}},
{m:"GET",p:"/api/v1/drama/:programId/season/:seasonId/episodes",d:"Episodes",ty:"list",pr:{programId:1,seasonId:1}},
{m:"GET",p:"/api/v1/play",d:"Play",ty:"video",q:{id:"Video ID"}}
]}
};

// ============================================
// CORE FUNCTIONS
// ============================================
const getToken=()=>document.getElementById('tokenInput').value||localStorage.getItem('sapimu_token')||'';
const wait=ms=>new Promise(r=>setTimeout(r,ms));
const extractParams=(p)=>(p.match(/:(\w+)/g)||[]).map(m=>m.slice(1));

function saveToken(){
  const t=document.getElementById('tokenInput').value.trim();
  if(!t)return alert('Enter token!');
  localStorage.setItem('sapimu_token',t);
  document.getElementById('tokenDot').className='token-dot active';
  document.getElementById('tokenStatusText').textContent='Active';
  document.getElementById('tokenStatusText').style.color='var(--green)';
  cache={ids:{},chapters:{}};
  localStorage.removeItem(CACHE_KEY);
  prefetchAll();
}

function loadToken(){
  const s=localStorage.getItem('sapimu_token')||TOKEN_DEFAULT;
  document.getElementById('tokenInput').value=s;
  if(s){
    document.getElementById('tokenDot').className='token-dot active';
    document.getElementById('tokenStatusText').textContent='Active';
    document.getElementById('tokenStatusText').style.color='var(--green)';
    localStorage.setItem('sapimu_token',s);
  }
}

// ============================================
// SEQUENTIAL FETCH - 1 BY 1
// ============================================
async function prefetchAll(){
  const token=getToken();
  if(!token)return;
  
  const keys=Object.keys(P);
  const total=keys.length;
  let done=0,success=0;
  failedPlatforms=[];
  
  document.getElementById('loadingBar').classList.add('show');
  document.getElementById('prefetchStatus').className='prefetch-status loading';
  
  // ONE BY ONE - no parallel!
  for(const k of keys){
    done++;
    document.getElementById('prefetchStatus').textContent=`[${done}/${total}] Loading ${P[k].n}...`;
    document.getElementById('loadingProgress').style.width=Math.round((done/total)*100)+'%';
    
    try{
      const items=await fetchPlatformIds(k);
      if(items.length>0) success++;
      else failedPlatforms.push(k);
    }catch(e){
      console.error(k,e);
      failedPlatforms.push(k);
    }
    
    // Update sidebar
    updateNavStatus(k);
    
    // Save after each success
    if(cache.ids[k]?.length) saveCache();
    
    // Delay between each request
    await wait(500);
  }
  
  document.getElementById('loadingBar').classList.remove('show');
  finishPrefetch(success,total);
  populateAllDropdowns();
}

async function fetchPlatformIds(k){
  const pl=P[k];
  if(!pl.l)return[];
  if(cache.ids[k]?.length)return cache.ids[k];
  
  const token=getToken();
  const url=`${BASE}/${k}${pl.l}`;
  
  // Try up to 3 times
  for(let attempt=0;attempt<3;attempt++){
    try{
      const r=await fetch(url,{
        headers:{'Authorization':`Bearer ${token}`},
        signal:AbortSignal.timeout(15000) // 15s timeout
      });
      
      if(!r.ok){
        if(attempt<2){await wait(1000*(attempt+1));continue;}
        return[];
      }
      
      const j=await r.json();
      
      let d=j;
      if(pl.pa)for(const x of pl.pa.split('.'))d=d?.[x];
      if(!Array.isArray(d))d=d?.list||d?.dramas||d?.items||d?.hall_list||Object.values(d||{})[0]||[];
      if(!Array.isArray(d))d=[];
      
      const items=d.slice(0,50).map(i=>({
        id:String(i[pl.id]||i.id||i.book_id||i.bookId||i.code||i.playlet_id||i.dcup||''),
        t:(i[pl.t]||i.title||i.name||i.bookName||'Unknown').substring(0,40)
      })).filter(x=>x.id);
      
      cache.ids[k]=items;
      return items;
    }catch(e){
      console.warn(`${k} attempt ${attempt+1} failed:`,e.message);
      if(attempt<2)await wait(2000*(attempt+1));
    }
  }
  return[];
}

function updateNavStatus(k){
  const nav=document.querySelector(`.nav-item[data-key="${k}"]`);
  if(!nav)return;
  nav.querySelector('.nav-status')?.remove();
  const span=document.createElement('span');
  span.className='nav-status';
  if(cache.ids[k]?.length){
    span.textContent='âœ“ '+cache.ids[k].length;
    span.style.color='var(--green)';
  }else{
    span.textContent='âœ—';
    span.style.color='var(--red)';
  }
  nav.appendChild(span);
}

function finishPrefetch(success,total){
  const totalIds=Object.values(cache.ids).reduce((a,b)=>a+b.length,0);
  if(failedPlatforms.length===0){
    document.getElementById('prefetchStatus').className='prefetch-status done';
    document.getElementById('prefetchStatus').textContent=`âœ“ All ${total} loaded! (${totalIds} IDs)`;
  }else{
    document.getElementById('prefetchStatus').className='prefetch-status error';
    document.getElementById('prefetchStatus').innerHTML=
      `âš  ${success}/${total} loaded (${totalIds} IDs). `+
      `<button onclick="retryFailed()" style="background:var(--yellow);color:#000;border:none;padding:4px 12px;border-radius:4px;cursor:pointer;font-weight:600">ðŸ”„ Retry ${failedPlatforms.length} failed</button>`+
      `<br><small style="color:var(--text3);margin-top:4px;display:block">Failed: ${failedPlatforms.map(k=>P[k].n).join(', ')}</small>`;
  }
}

async function retryFailed(){
  if(!failedPlatforms.length)return;
  const toRetry=[...failedPlatforms];
  failedPlatforms=[];
  let success=0;
  
  document.getElementById('prefetchStatus').className='prefetch-status loading';
  
  for(let i=0;i<toRetry.length;i++){
    const k=toRetry[i];
    document.getElementById('prefetchStatus').textContent=`Retrying [${i+1}/${toRetry.length}] ${P[k].n}...`;
    
    // Clear old cache to force re-fetch
    delete cache.ids[k];
    
    try{
      const items=await fetchPlatformIds(k);
      if(items.length>0){success++;saveCache();}
      else failedPlatforms.push(k);
    }catch(e){
      failedPlatforms.push(k);
    }
    
    updateNavStatus(k);
    await wait(1500); // Longer delay for retry
  }
  
  const loaded=Object.keys(cache.ids).filter(k=>cache.ids[k]?.length).length;
  finishPrefetch(loaded,Object.keys(P).length);
  populateAllDropdowns();
}

// ============================================
// DROPDOWNS
// ============================================
function populateAllDropdowns(){
  Object.keys(P).forEach(k=>{
    const items=cache.ids[k]||[];
    P[k].ep.forEach((ep,i)=>{
      extractParams(ep.p).forEach(pr=>{
        if(ep.pr?.[pr]===1){
          const sel=document.getElementById(`sel-${k}-${i}-${pr}`);
          if(sel){
            if(items.length>0){
              sel.innerHTML='<option value="">-- Select ('+items.length+') --</option>'+
                items.map(d=>`<option value="${d.id}">${d.id} - ${d.t}</option>`).join('');
              sel.classList.add('loaded');
              sel.classList.remove('error');
            }else{
              sel.innerHTML='<option value="">-- No data --</option>';
              sel.classList.add('error');
            }
          }
        }
      });
    });
  });
}

// ============================================
// URL BUILDER
// ============================================
function buildUrl(k,i){
  const ep=P[k].ep[i];
  let p=ep.p;
  extractParams(p).forEach(pr=>{
    const sel=document.getElementById(`sel-${k}-${i}-${pr}`);
    const inp=document.getElementById(`inp-${k}-${i}-${pr}`);
    const v=sel?.value||inp?.value?.trim()||'';
    if(v)p=p.replace(`:${pr}`,encodeURIComponent(v));
  });
  const qs=[];
  if(ep.ty==='list'){
    const page=document.getElementById(`q-${k}-${i}-page`)?.value;
    const limit=document.getElementById(`q-${k}-${i}-limit`)?.value;
    const lang=document.getElementById(`q-${k}-${i}-lang`)?.value;
    if(page)qs.push(`page=${page}`);
    if(limit)qs.push(`limit=${limit}`);
    if(lang)qs.push(`lang=${lang}`);
  }
  if(ep.q){
    Object.keys(ep.q).forEach(qk=>{
      if(['page','limit','lang'].includes(qk))return;
      const v=document.getElementById(`q-${k}-${i}-${qk}`)?.value?.trim();
      if(v)qs.push(`${qk}=${encodeURIComponent(v)}`);
    });
  }
  if(qs.length)p+='?'+qs.join('&');
  return `${BASE}/${k}${p}`;
}

function updateUrl(k,i){
  const el=document.getElementById(`url-${k}-${i}`);
  if(el)el.value=buildUrl(k,i);
}

function changePage(k,i,delta){
  const inp=document.getElementById(`q-${k}-${i}-page`);
  if(!inp)return;
  let v=parseInt(inp.value)||1;
  v+=delta;if(v<1)v=1;
  inp.value=v;
  updateUrl(k,i);
}

// ============================================
// RENDER
// ============================================
let totalEp=0;Object.values(P).forEach(p=>totalEp+=p.ep.length);

function renderSidebar(){
  const nav=document.getElementById('sidebarNav');
  const sorted=Object.entries(P).sort((a,b)=>a[1].n.localeCompare(b[1].n));
  nav.innerHTML=sorted.map(([k,p])=>`<div class="nav-item" data-key="${k}" onclick="scrollTo('${k}')"><div class="nav-icon">${p.n.slice(0,2).toUpperCase()}</div><div class="nav-name">${p.n}</div><div class="nav-count">${p.ep.length}</div></div>`).join('');
}

function hl(p){return p.replace(/:(\w+)/g,'<span class="param">:$1</span>');}

function renderContent(){
  const content=document.getElementById('content');
  const sorted=Object.entries(P).sort((a,b)=>a[1].n.localeCompare(b[1].n));
  
  let html=sorted.map(([k,pl])=>{
    const eps=pl.ep.map((ep,i)=>{
      const prs=extractParams(ep.p);
      const hasP=prs.length>0;
      const hasQ=ep.q&&Object.keys(ep.q).length>0;
      const isList=ep.ty==='list';
      
      let paramHtml='<div class="param-grid">';
      if(isList){
        paramHtml+=`<div class="param-item"><label>page <span class="opt">(opt)</span></label><div class="page-ctrl"><button onclick="changePage('${k}',${i},-1)">âˆ’</button><input type="number" id="q-${k}-${i}-page" value="1" min="1" oninput="updateUrl('${k}',${i})"><button onclick="changePage('${k}',${i},1)">+</button></div></div>
        <div class="param-item"><label>limit <span class="opt">(opt)</span></label><input type="number" id="q-${k}-${i}-limit" value="20" oninput="updateUrl('${k}',${i})"></div>
        <div class="param-item"><label>lang <span class="opt">(opt)</span></label><select id="q-${k}-${i}-lang" onchange="updateUrl('${k}',${i})"><option value="">Auto</option>${LANGS.map(l=>`<option value="${l.c}"${l.c==='id'?' selected':''}>${l.n}</option>`).join('')}</select></div>`;
      }
      if(hasP){
        prs.forEach(pr=>{
          if(ep.pr?.[pr]===0){
            paramHtml+=`<div class="param-item"><label>${pr} <span class="req">*</span></label><input type="text" id="inp-${k}-${i}-${pr}" placeholder="${pr}" oninput="updateUrl('${k}',${i})" value="${pr==='page'?'1':''}"></div>`;
          }else{
            paramHtml+=`<div class="param-item"><label>${pr} <span class="req">*</span></label><select id="sel-${k}-${i}-${pr}" onchange="updateUrl('${k}',${i})"><option value="">Loading...</option></select><input type="text" id="inp-${k}-${i}-${pr}" placeholder="Or type ID" oninput="updateUrl('${k}',${i})" style="margin-top:4px;font-size:10px"></div>`;
          }
        });
      }
      if(hasQ){
        Object.entries(ep.q).forEach(([qk,qd])=>{
          if(isList&&['page','limit','lang'].includes(qk))return;
          paramHtml+=`<div class="param-item"><label>${qk} <span class="opt">(query)</span></label><input type="text" id="q-${k}-${i}-${qk}" placeholder="${qd}" oninput="updateUrl('${k}',${i})"></div>`;
        });
      }
      paramHtml+='</div>';
      
      return `<div class="endpoint-card" id="${k}-${i}"><div class="endpoint-header" onclick="toggle('${k}-${i}')"><span class="method-badge method-${ep.m}">${ep.m}</span><span class="endpoint-path">${hl(ep.p)}</span><span class="endpoint-desc">${ep.d}</span><span class="endpoint-toggle">â–¼</span></div><div class="endpoint-detail"><div class="detail-section"><h4>Parameters</h4>${paramHtml}</div><div class="try-section"><div class="try-url"><input type="text" value="${BASE}/${k}${ep.p}" id="url-${k}-${i}" readonly><button class="btn-copy" onclick="copy('url-${k}-${i}')">ðŸ“‹</button><button class="btn-curl" onclick="copyCurl('${k}',${i})">cURL</button><button class="btn-send" onclick="send('${k}',${i})">â–¶ Send</button></div><div class="response-box" id="resp-${k}-${i}"><div class="response-header"><span class="response-status" id="rs-${k}-${i}"></span><div class="response-actions"><span id="rz-${k}-${i}"></span><button onclick="copy('rb-${k}-${i}')">ðŸ“‹</button><button onclick="document.getElementById('resp-${k}-${i}').style.display='none'">âœ•</button></div></div><pre class="response-body" id="rb-${k}-${i}"></pre></div></div></div></div>`;
    }).join('');
    
    return `<div class="platform-section" id="p-${k}"><div class="platform-header"><div class="platform-icon">${pl.n.slice(0,2).toUpperCase()}</div><div><h2>${pl.n}</h2><div class="platform-meta">Base: <code>/${k}</code> Â· ${pl.ep.length} endpoints</div></div></div>${eps}</div>`;
  }).join('');
  
  content.innerHTML=html;
}

// ============================================
// INTERACTIONS
// ============================================
const toggle=(id)=>document.getElementById(id).classList.toggle('open');
const scrollTo=(k)=>{document.getElementById('p-'+k)?.scrollIntoView({behavior:'smooth'});document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));document.querySelector(`.nav-item[data-key="${k}"]`)?.classList.add('active');if(window.innerWidth<768)toggleSidebar();};
const filterPlatforms=()=>{const q=document.getElementById('searchInput').value.toLowerCase();document.querySelectorAll('.nav-item').forEach(n=>{n.style.display=n.querySelector('.nav-name').textContent.toLowerCase().includes(q)?'flex':'none';});document.querySelectorAll('.platform-section').forEach(s=>{s.style.display=s.querySelector('h2').textContent.toLowerCase().includes(q)?'block':'none';});};
const toggleSidebar=()=>{document.getElementById('sidebar').classList.toggle('open');document.getElementById('overlay').classList.toggle('show');};
const copy=(id)=>navigator.clipboard.writeText(document.getElementById(id).value||document.getElementById(id).textContent);
const copyCurl=(k,i)=>{const url=buildUrl(k,i).replace(/^\/api\//,'https://captain.sapimu.au/');navigator.clipboard.writeText(`curl "${url}" -H "Authorization: Bearer ${getToken()}"`);alert('Copied!');};

async function send(k,i){
  const t=getToken();if(!t)return alert('Set token first!');
  const url=buildUrl(k,i);
  const ep=P[k].ep[i];
  const box=document.getElementById(`resp-${k}-${i}`);
  const st=document.getElementById(`rs-${k}-${i}`);
  const sz=document.getElementById(`rz-${k}-${i}`);
  const bd=document.getElementById(`rb-${k}-${i}`);
  
  box.style.display='block';st.textContent='â³ Loading...';st.className='response-status loading';bd.textContent='';
  
  try{
    const r=await fetch(url,{method:ep.m,headers:{Authorization:`Bearer ${t}`}});
    const txt=await r.text();
    st.textContent=`${r.status} ${r.statusText}`;st.className=`response-status ${r.ok?'ok':'err'}`;
    sz.textContent=`${(txt.length/1024).toFixed(1)}KB`;
    try{bd.textContent=JSON.stringify(JSON.parse(txt),null,2);}catch{bd.textContent=txt;}
  }catch(e){
    st.textContent='âŒ Error';st.className='response-status err';
    bd.textContent=`Error: ${e.message}`;
  }
}

// ============================================
// INIT
// ============================================
document.getElementById('statPlatforms').textContent=Object.keys(P).length;
document.getElementById('statEndpoints').textContent=totalEp;
document.getElementById('badgePlatforms').textContent=Object.keys(P).length;
document.getElementById('badgeEndpoints').textContent=totalEp;

loadCache();
renderSidebar();
renderContent();
loadToken();

// Start
async function init(){
  if(BASE==='/api'){
    // Vercel - test proxy first
    try{
      const r=await fetch('/api/health-check-test-'+Date.now());
      // Even 404 means proxy works
      console.log('Proxy responding:', r.status);
    }catch(e){
      document.getElementById('prefetchStatus').className='prefetch-status error';
      document.getElementById('prefetchStatus').textContent='âŒ Proxy error: '+e.message;
      return;
    }
  }
  
  const cached=Object.keys(cache.ids).filter(k=>cache.ids[k]?.length).length;
  if(cached>0){
    populateAllDropdowns();
    // Update sidebar
    Object.keys(cache.ids).forEach(k=>updateNavStatus(k));
    const totalIds=Object.values(cache.ids).reduce((a,b)=>a+b.length,0);
    
    if(cached>=Object.keys(P).length){
      document.getElementById('prefetchStatus').className='prefetch-status done';
      document.getElementById('prefetchStatus').textContent=`âœ“ Cache loaded! (${totalIds} IDs, ${cached} platforms)`;
    }else{
      document.getElementById('prefetchStatus').className='prefetch-status done';
      document.getElementById('prefetchStatus').innerHTML=
        `âœ“ Cache: ${cached}/${Object.keys(P).length} platforms (${totalIds} IDs). `+
        `<button onclick="prefetchAll()" style="background:var(--accent);color:#fff;border:none;padding:4px 12px;border-radius:4px;cursor:pointer">Load remaining</button>`;
    }
  }else if(getToken()){
    setTimeout(prefetchAll,500);
  }
}

init();
</script>
