<script>
var DIRECT='https://captain.sapimu.au';
var PROXY='/api/proxy';
var isLocal=['localhost','127.0.0.1'].indexOf(window.location.hostname)!==-1;
var TOKEN_DEFAULT="53d25de32c37b0fcd2b14a9f834050493cc044d5039b5aff3283da73a8ef761b";
var CACHE_KEY="sapimu_cache_v8";
var LANGS=[{c:"id",n:"Indonesian"},{c:"en",n:"English"},{c:"th",n:"Thai"},{c:"vi",n:"Vietnamese"},{c:"pt",n:"Portuguese"},{c:"es",n:"Spanish"},{c:"ja",n:"Japanese"},{c:"ko",n:"Korean"},{c:"zh",n:"Chinese"},{c:"ar",n:"Arabic"},{c:"fr",n:"French"},{c:"de",n:"German"}];

function makeUrl(apiPath,queryParams){
  if(isLocal){
    var qs=Object.entries(queryParams||{}).filter(function(e){return e[1]}).map(function(e){return e[0]+'='+encodeURIComponent(e[1])}).join('&');
    return DIRECT+'/'+apiPath+(qs?'?'+qs:'');
  }
  var p=new URLSearchParams();
  p.set('path',apiPath);
  Object.entries(queryParams||{}).forEach(function(e){if(e[1])p.set(e[0],e[1]);});
  return PROXY+'?'+p.toString();
}

function directUrl(apiPath,queryParams){
  var qs=Object.entries(queryParams||{}).filter(function(e){return e[1]}).map(function(e){return e[0]+'='+encodeURIComponent(e[1])}).join('&');
  return DIRECT+'/'+apiPath+(qs?'?'+qs:'');
}

var cache={ids:{},chapters:{}};
var failedPlatforms=[];
var failedErrors={};
function wait(ms){return new Promise(function(r){setTimeout(r,ms)})}
function loadCache(){try{var s=localStorage.getItem(CACHE_KEY);if(s)cache=JSON.parse(s);}catch(e){}}
function saveCache(){try{localStorage.setItem(CACHE_KEY,JSON.stringify(cache));}catch(e){}}

var P={
bilitv:{n:"BiliTV",l:"/api/v1/home",id:"id",t:"title",pa:"dramas",ep:[
{m:"GET",p:"/api/v1/languages",d:"Languages",ty:"meta"},
{m:"GET",p:"/api/v1/home",d:"Home",ty:"list"},
{m:"GET",p:"/api/v1/search",d:"Search",ty:"list",q:{q:"Keyword"}},
{m:"GET",p:"/api/v1/recommend",d:"Recommended",ty:"list"},
{m:"GET",p:"/api/v1/dramas",d:"Dramas",ty:"list"},
{m:"GET",p:"/api/v1/drama/:id",d:"Detail",ty:"detail",pr:{id:1}},
{m:"GET",p:"/api/v1/drama/:id/episode/:ep",d:"Episode",ty:"video",pr:{id:1,ep:1}}
]},
cashdrama:{n:"CashDrama",l:"/api/v1/home",id:"id",t:"name",pa:"data.list",ep:[
{m:"GET",p:"/api/v1/languages",d:"Languages",ty:"meta"},
{m:"GET",p:"/api/v1/home",d:"Home",ty:"list"},
{m:"GET",p:"/api/v1/blocks",d:"Blocks",ty:"list"},
{m:"GET",p:"/api/v1/search",d:"Search",ty:"list",q:{q:"Keyword"}},
{m:"GET",p:"/api/v1/drama/:vid",d:"Detail",ty:"detail",pr:{vid:1}},
{m:"GET",p:"/api/v1/drama/:vid/episodes",d:"Episodes",ty:"list",pr:{vid:1}},
{m:"GET",p:"/api/v1/play/:vid/:ep",d:"Play",ty:"video",pr:{vid:1,ep:1}}
]},
dotdrama:{n:"DotDrama",l:"/api/v1/dramas",id:"dcup",t:"title",pa:"dgiv.lint",ep:[
{m:"GET",p:"/api/v1/dramas",d:"Dramas",ty:"list"},
{m:"GET",p:"/api/v1/collections",d:"Collections",ty:"list"},
{m:"GET",p:"/api/v1/categories",d:"Categories",ty:"list"},
{m:"GET",p:"/api/v1/dramas/:id",d:"Detail",ty:"detail",pr:{id:1}}
]},
dramabite:{n:"DramaBite",l:"/api/v1/dramas",id:"id",t:"title",pa:"data",ep:[
{m:"GET",p:"/api/v1/languages",d:"Languages",ty:"meta"},
{m:"GET",p:"/api/v1/dramas",d:"Dramas",ty:"list"},
{m:"GET",p:"/api/v1/foryou",d:"For You",ty:"list"},
{m:"GET",p:"/api/v1/hot",d:"Hot",ty:"list"},
{m:"GET",p:"/api/v1/search",d:"Search",ty:"list",q:{q:"Keyword"}},
{m:"GET",p:"/api/v1/drama/:id",d:"Detail",ty:"detail",pr:{id:1}},
{m:"GET",p:"/api/v1/drama/:id/episode/:ep",d:"Episode",ty:"video",pr:{id:1,ep:1}}
]},
dramabox:{n:"DramaBox",l:"/api/v1/foryou/1",id:"book_id",t:"name",pa:"data.list",ep:[
{m:"GET",p:"/api/v1/foryou/:page",d:"For You",ty:"list",pr:{page:0}},
{m:"GET",p:"/api/v1/new/:page",d:"New",ty:"list",pr:{page:0}},
{m:"GET",p:"/api/v1/rank/:type",d:"Ranking",ty:"list",pr:{type:0}},
{m:"GET",p:"/api/v1/search/:keyword/:page",d:"Search",ty:"list",pr:{keyword:0,page:0}},
{m:"GET",p:"/api/v1/chapters/:bookId",d:"Chapters",ty:"list",pr:{bookId:1}},
{m:"GET",p:"/api/v1/watch/:bookId/:index",d:"Watch",ty:"video",pr:{bookId:1,index:1}}
]},
dramadash:{n:"DramaDash",l:"/api/v1/home",id:"id",t:"name",pa:"data.banner",ep:[
{m:"GET",p:"/api/v1/home",d:"Home",ty:"list"},
{m:"GET",p:"/api/v1/tabs/:id",d:"Tab",ty:"list",pr:{id:0}},
{m:"GET",p:"/api/v1/search/:query",d:"Search",ty:"list",pr:{query:0}},
{m:"GET",p:"/api/v1/drama/:id",d:"Detail",ty:"detail",pr:{id:1}},
{m:"GET",p:"/api/v1/episode/:dramaId/:eps",d:"Episode",ty:"video",pr:{dramaId:1,eps:1}}
]},
dramanow:{n:"DramaNow",l:"/api/v1/series",id:"id",t:"title",pa:"data",ep:[
{m:"GET",p:"/api/v1/languages",d:"Languages",ty:"meta"},
{m:"GET",p:"/api/v1/search",d:"Search",ty:"list",q:{q:"Keyword"}},
{m:"GET",p:"/api/v1/series",d:"Series",ty:"list",q:{id:"Series ID"}},
{m:"GET",p:"/api/v1/video",d:"Video",ty:"video",q:{id:"Video ID"}}
]},
dramanova:{n:"DramaNova",l:"/api/v1/dramas",id:"id",t:"title",pa:"data",ep:[
{m:"GET",p:"/api/v1/languages",d:"Languages",ty:"meta"},
{m:"GET",p:"/api/v1/dramas",d:"Dramas",ty:"list"},
{m:"GET",p:"/api/v1/search",d:"Search",ty:"list",q:{q:"Keyword"}},
{m:"GET",p:"/api/v1/recommend",d:"Recommended",ty:"list"},
{m:"GET",p:"/api/v1/drama/:id",d:"Detail",ty:"detail",pr:{id:1}},
{m:"GET",p:"/api/v1/drama/:id/episode/:ep",d:"Episode",ty:"video",pr:{id:1,ep:1}}
]},
dramapops:{n:"DramaPops",l:"/api/v1/dramas",id:"id",t:"title",pa:"data",ep:[
{m:"GET",p:"/api/v1/languages",d:"Languages",ty:"meta"},
{m:"GET",p:"/api/v1/homepage",d:"Homepage",ty:"list"},
{m:"GET",p:"/api/v1/dramas",d:"Dramas",ty:"list"},
{m:"GET",p:"/api/v1/dramas/trending",d:"Trending",ty:"list"},
{m:"GET",p:"/api/v1/dramas/popular",d:"Popular",ty:"list"},
{m:"GET",p:"/api/v1/search",d:"Search",ty:"list",q:{q:"Keyword"}},
{m:"GET",p:"/api/v1/drama/:id",d:"Detail",ty:"detail",pr:{id:1}},
{m:"GET",p:"/api/v1/drama/:id/episode/:ep/video",d:"Video",ty:"video",pr:{id:1,ep:1}}
]},
dramarush:{n:"DramaRush",l:"/api/v1/tabs/1",id:"id",t:"name",pa:"data",ep:[
{m:"GET",p:"/api/v1/config",d:"Config",ty:"meta"},
{m:"GET",p:"/api/v1/ranking",d:"Ranking",ty:"list"},
{m:"GET",p:"/api/v1/tabs/:id",d:"Tab",ty:"list",pr:{id:0}},
{m:"GET",p:"/api/v1/search/:q",d:"Search",ty:"list",pr:{q:0}},
{m:"GET",p:"/api/v1/drama/:id",d:"Detail",ty:"detail",pr:{id:1}},
{m:"GET",p:"/api/v1/play/:id",d:"Episodes",ty:"list",pr:{id:1}},
{m:"GET",p:"/api/v1/play/:id/:ep",d:"Episode",ty:"video",pr:{id:1,ep:1}}
]},
dramawave:{n:"DramaWave",l:"/api/v1/feed/popular",id:"id",t:"name",pa:"data",ep:[
{m:"GET",p:"/api/v1/languages",d:"Languages",ty:"meta"},
{m:"GET",p:"/api/v1/feed/:tab",d:"Feed",ty:"list",pr:{tab:0}},
{m:"GET",p:"/api/v1/search",d:"Search",ty:"list",q:{q:"Keyword"}},
{m:"GET",p:"/api/v1/search/hot",d:"Hot keywords",ty:"list"},
{m:"GET",p:"/api/v1/dramas/:id",d:"Detail",ty:"detail",pr:{id:1}},
{m:"GET",p:"/api/v1/dramas/:id/play/:ep",d:"Episode",ty:"video",pr:{id:1,ep:1}}
]},
dreamshort:{n:"DreamShort",l:"/discover/sections",id:"bookId",t:"bookName",pa:"data",ep:[
{m:"GET",p:"/discover/sections",d:"Sections",ty:"list",q:{tabId:"Tab ID"}},
{m:"GET",p:"/search/books",d:"Search",ty:"list",q:{keyword:"Keyword"}},
{m:"GET",p:"/book/getBookDetail",d:"Detail",ty:"detail",q:{bookId:"Book ID"}},
{m:"GET",p:"/bookShelf/chapterList",d:"Chapters",ty:"list",q:{bookId:"Book ID"}},
{m:"GET",p:"/book/getChapterDetail",d:"Chapter",ty:"video",q:{bookId:"Book ID",chapterId:"Chapter ID"}}
]},
flickreels:{n:"FlickReels",l:"/api/v1/for-you",id:"playlet_id",t:"name",pa:"data",ep:[
{m:"GET",p:"/api/v1/for-you",d:"For You",ty:"list"},
{m:"GET",p:"/api/v1/hot-rank",d:"Hot",ty:"list"},
{m:"GET",p:"/api/v1/search",d:"Search",ty:"list",q:{q:"Keyword"}},
{m:"GET",p:"/api/v1/navigation",d:"Categories",ty:"list"},
{m:"GET",p:"/api/v1/category/:navId",d:"Category",ty:"list",pr:{navId:0}},
{m:"GET",p:"/api/v1/play/:playletId",d:"Detail",ty:"detail",pr:{playletId:1}},
{m:"GET",p:"/api/v1/chapters/:playletId",d:"Chapters",ty:"list",pr:{playletId:1}},
{m:"GET",p:"/api/v1/stream/:playletId/:chapterNum",d:"Stream",ty:"video",pr:{playletId:1,chapterNum:1}}
]},
flickshort:{n:"FlickShort",l:"/api/v1/home",id:"id",t:"title",pa:"data",ep:[
{m:"GET",p:"/api/v1/languages",d:"Languages",ty:"meta"},
{m:"GET",p:"/api/v1/home",d:"Home",ty:"list"},
{m:"GET",p:"/api/v1/search",d:"Search",ty:"list",q:{q:"Keyword"}},
{m:"GET",p:"/api/v1/recommend",d:"Recommended",ty:"list"},
{m:"GET",p:"/api/v1/drama/:id",d:"Detail",ty:"detail",pr:{id:1}},
{m:"GET",p:"/api/v1/drama/:id/episode/:ep",d:"Episode",ty:"video",pr:{id:1,ep:1}}
]},
flextv:{n:"FlexTV",l:"/api/v1/tabs/popular",id:"id",t:"name",pa:"data.list",ep:[
{m:"GET",p:"/api/v1/languages",d:"Languages",ty:"meta"},
{m:"GET",p:"/api/v1/tabs",d:"Tabs",ty:"list"},
{m:"GET",p:"/api/v1/tabs/:name",d:"Tab content",ty:"list",pr:{name:0}},
{m:"GET",p:"/api/v1/search",d:"Search",ty:"list",q:{q:"Keyword"}},
{m:"GET",p:"/api/v1/series/:id",d:"Detail",ty:"detail",pr:{id:1}},
{m:"GET",p:"/api/v1/series/:id/episodes",d:"Episodes",ty:"list",pr:{id:1}},
{m:"GET",p:"/api/v1/play/:series_id/:section_id",d:"Play",ty:"video",pr:{series_id:1,section_id:1}}
]},
freereels:{n:"FreeReels",l:"/api/v1/popular",id:"id",t:"title",pa:"data",ep:[
{m:"GET",p:"/api/v1/foryou",d:"For You",ty:"list"},
{m:"GET",p:"/api/v1/popular",d:"Popular",ty:"list"},
{m:"GET",p:"/api/v1/new",d:"New",ty:"list"},
{m:"GET",p:"/api/v1/female",d:"Female",ty:"list"},
{m:"GET",p:"/api/v1/male",d:"Male",ty:"list"},
{m:"GET",p:"/api/v1/search",d:"Search",ty:"list",q:{q:"Keyword"}},
{m:"GET",p:"/api/v1/dramas/:id",d:"Detail",ty:"detail",pr:{id:1}},
{m:"GET",p:"/api/v1/dramas/:id/episodes",d:"Episodes",ty:"list",pr:{id:1}},
{m:"GET",p:"/api/v1/dramas/:id/play/:ep",d:"Play",ty:"video",pr:{id:1,ep:1}}
]},
fundrama:{n:"FunDrama",l:"/api/v1/dramas",id:"id",t:"title",pa:"data",ep:[
{m:"GET",p:"/api/v1/languages",d:"Languages",ty:"meta"},
{m:"GET",p:"/api/v1/dramas",d:"Dramas",ty:"list"},
{m:"GET",p:"/api/v1/search",d:"Search",ty:"list",q:{q:"Keyword"}},
{m:"GET",p:"/api/v1/drama/:id",d:"Detail",ty:"detail",pr:{id:1}},
{m:"GET",p:"/api/v1/drama/:id/episodes",d:"Episodes",ty:"list",pr:{id:1}},
{m:"GET",p:"/api/v1/drama/:id/episode/:ep",d:"Episode",ty:"video",pr:{id:1,ep:1}}
]},
goodshort:{n:"GoodShort",l:"/api/v1/home",id:"bookId",t:"bookName",pa:"data.list",ep:[
{m:"GET",p:"/api/v1/home",d:"Home",ty:"list"},
{m:"GET",p:"/api/v1/search",d:"Search",ty:"list",q:{q:"Keyword"}},
{m:"GET",p:"/api/v1/book/:id",d:"Detail",ty:"detail",pr:{id:1}},
{m:"GET",p:"/api/v1/chapters/:bookId",d:"Chapters",ty:"list",pr:{bookId:1}},
{m:"GET",p:"/api/v1/play/:bookId/:chapterId",d:"Play",ty:"video",pr:{bookId:1,chapterId:1}},
{m:"GET",p:"/api/v1/unlock/:bookId",d:"Unlock all",ty:"action",pr:{bookId:1}}
]},
hishort:{n:"HiShort",l:"/api/v1/home",id:"id",t:"title",pa:"data.popular",ep:[
{m:"GET",p:"/api/v1/home",d:"Home",ty:"list"},
{m:"GET",p:"/api/v1/search",d:"Search",ty:"list",q:{q:"Keyword"}},
{m:"GET",p:"/api/v1/drama/:id",d:"Detail",ty:"detail",pr:{id:1}},
{m:"GET",p:"/api/v1/episode/:slug",d:"Episode",ty:"video",pr:{slug:1}}
]},
idrama:{n:"iDrama",l:"/api/v1/popular",id:"id",t:"title",pa:"data",ep:[
{m:"GET",p:"/api/v1/popular",d:"Popular",ty:"list"},
{m:"GET",p:"/api/v1/latest",d:"Latest",ty:"list"},
{m:"GET",p:"/api/v1/search",d:"Search",ty:"list",q:{q:"Keyword"}},
{m:"GET",p:"/api/v1/genres",d:"Genres",ty:"list"},
{m:"GET",p:"/api/v1/genre/:id",d:"Genre",ty:"list",pr:{id:0}},
{m:"GET",p:"/api/v1/drama/:id",d:"Detail",ty:"detail",pr:{id:1}},
{m:"POST",p:"/api/v1/unlock/:dramaId/:start/:end",d:"Unlock",ty:"action",pr:{dramaId:1,start:0,end:0}}
]},
kalostv:{n:"KalosTV",l:"/api/v1/home",id:"id",t:"name",pa:"data",ep:[
{m:"GET",p:"/api/v1/tabs",d:"Tabs",ty:"list"},
{m:"GET",p:"/api/v1/home",d:"Home",ty:"list"},
{m:"GET",p:"/api/v1/foryou",d:"For You",ty:"list"},
{m:"GET",p:"/api/v1/search",d:"Search",ty:"list",q:{q:"Keyword"}},
{m:"GET",p:"/api/v1/video/:id",d:"Detail",ty:"detail",pr:{id:1}},
{m:"GET",p:"/api/v1/video/:id/episodes",d:"Episodes",ty:"list",pr:{id:1}},
{m:"GET",p:"/api/v1/video/:id/episode/:ep",d:"Episode",ty:"video",pr:{id:1,ep:1}},
{m:"GET",p:"/api/v1/rank",d:"Ranking",ty:"list"},
{m:"GET",p:"/api/v1/categories",d:"Categories",ty:"list"},
{m:"GET",p:"/api/v1/tag/:id",d:"Tag",ty:"list",pr:{id:0}}
]},
melolo:{n:"Melolo",l:"/api/v1/bookmall",id:"id",t:"title",pa:"data",ep:[
{m:"GET",p:"/api/v1/languages",d:"Languages",ty:"meta"},
{m:"GET",p:"/api/v1/bookmall",d:"Bookmall",ty:"list"},
{m:"GET",p:"/api/v1/search",d:"Search",ty:"list",q:{q:"Keyword"}},
{m:"GET",p:"/api/v1/series",d:"Series",ty:"detail",q:{id:"Series ID"}},
{m:"GET",p:"/api/v1/video",d:"Video",ty:"video",q:{id:"Video ID"}},
{m:"GET",p:"/api/v1/batch/videos",d:"Batch videos",ty:"video"}
]},
meloshort:{n:"MeloShort",l:"/api/v1/dramas",id:"id",t:"title",pa:"data",ep:[
{m:"GET",p:"/api/v1/dramas",d:"Dramas",ty:"list"},
{m:"GET",p:"/api/v1/dramas/discover",d:"Discover",ty:"list"},
{m:"GET",p:"/api/v1/dramas/top",d:"Top",ty:"list"},
{m:"GET",p:"/api/v1/dramas/search",d:"Search",ty:"list",q:{q:"Keyword"}},
{m:"GET",p:"/api/v1/dramas/:id/episodes",d:"Episodes",ty:"list",pr:{id:1}},
{m:"GET",p:"/api/v1/dramas/:id/episodes/:chapter",d:"Episode",ty:"video",pr:{id:1,chapter:1}}
]},
microdrama:{n:"MicroDrama",l:"/api/v1/dramas",id:"id",t:"title",pa:"data",ep:[
{m:"GET",p:"/api/v1/languages",d:"Languages",ty:"meta"},
{m:"GET",p:"/api/v1/dramas",d:"Dramas",ty:"list"},
{m:"GET",p:"/api/v1/dramas/search",d:"Search",ty:"list",q:{q:"Keyword"}},
{m:"GET",p:"/api/v1/dramas/:id",d:"Detail",ty:"detail",pr:{id:1}}
]},
minutedrama:{n:"MinuteDrama",l:"/api/v1/popular",id:"id",t:"title",pa:"data",ep:[
{m:"GET",p:"/api/v1/popular",d:"Popular",ty:"list"},
{m:"GET",p:"/api/v1/search",d:"Search",ty:"list",q:{q:"Keyword"}},
{m:"GET",p:"/api/v1/videos/:id",d:"Detail",ty:"detail",pr:{id:1}}
]},
mydrama:{n:"MyDrama",l:"/api/v1/series",id:"id",t:"title",pa:"data",ep:[
{m:"GET",p:"/api/v1/languages",d:"Languages",ty:"meta"},
{m:"GET",p:"/api/v1/tags",d:"Tags",ty:"list"},
{m:"GET",p:"/api/v1/series",d:"Series",ty:"list"},
{m:"GET",p:"/api/v1/search",d:"Search",ty:"list",q:{q:"Keyword"}},
{m:"GET",p:"/api/v1/series/:id",d:"Detail",ty:"detail",pr:{id:1}},
{m:"GET",p:"/api/v1/series/:id/episodes",d:"Episodes",ty:"list",pr:{id:1}},
{m:"GET",p:"/api/v1/video/:seriesId/:position",d:"Video",ty:"video",pr:{seriesId:1,position:1}}
]},
netshort:{n:"NetShort",l:"/api/v1/feed/1",id:"id",t:"name",pa:"data.list",ep:[
{m:"GET",p:"/api/v1/languages",d:"Languages",ty:"meta"},
{m:"GET",p:"/api/v1/feed/:page",d:"Feed",ty:"list",pr:{page:0}},
{m:"GET",p:"/api/v1/explore/:page",d:"Explore",ty:"list",pr:{page:0}},
{m:"GET",p:"/api/v1/new/:page",d:"New",ty:"list",pr:{page:0}},
{m:"GET",p:"/api/v1/search/:keyword/:page",d:"Search",ty:"list",pr:{keyword:0,page:0}},
{m:"GET",p:"/api/v1/categories",d:"Categories",ty:"list"},
{m:"GET",p:"/api/v1/detail/:id",d:"Detail",ty:"detail",pr:{id:1}},
{m:"GET",p:"/api/v1/episodes/:id",d:"Episodes",ty:"list",pr:{id:1}},
{m:"GET",p:"/api/v1/episode/:id/:episodeNo",d:"Episode",ty:"video",pr:{id:1,episodeNo:1}}
]},
radreels:{n:"RadReels",l:"/api/v1/home",id:"id",t:"name",pa:"data",ep:[
{m:"GET",p:"/api/v1/home",d:"Home",ty:"list"},
{m:"GET",p:"/api/v1/foryou",d:"For You",ty:"list"},
{m:"GET",p:"/api/v1/ranking",d:"Ranking",ty:"list"},
{m:"GET",p:"/api/v1/tab/:id",d:"Tab",ty:"list",pr:{id:0}},
{m:"GET",p:"/api/v1/search/:query",d:"Search",ty:"list",pr:{query:0}},
{m:"GET",p:"/api/v1/drama/:keyword",d:"Detail",ty:"detail",pr:{keyword:1}},
{m:"GET",p:"/api/v1/episodes/:fakeId",d:"Episodes",ty:"list",pr:{fakeId:1}},
{m:"GET",p:"/api/v1/video/:videoFakeId/:episodicDramaId",d:"Video",ty:"video",pr:{videoFakeId:1,episodicDramaId:1}}
]},
rapidtv:{n:"RapidTV",l:"/api/v1/dramas",id:"id",t:"title",pa:"data",ep:[
{m:"GET",p:"/api/v1/dramas",d:"Dramas",ty:"list"},
{m:"GET",p:"/api/v1/search",d:"Search",ty:"list",q:{q:"Keyword"}},
{m:"GET",p:"/api/v1/dramas/:id",d:"Detail",ty:"detail",pr:{id:1}},
{m:"GET",p:"/api/v1/dramas/:id/episodes",d:"Episodes",ty:"list",pr:{id:1}}
]},
reelife:{n:"Reelife",l:"/api/v1/dramas",id:"id",t:"title",pa:"data",ep:[
{m:"GET",p:"/api/v1/dramas",d:"Dramas",ty:"list"},
{m:"GET",p:"/api/v1/foryou",d:"For You",ty:"list"},
{m:"GET",p:"/api/v1/search",d:"Search",ty:"list",q:{q:"Keyword"}},
{m:"GET",p:"/api/v1/dramas/:id",d:"Detail",ty:"detail",pr:{id:1}},
{m:"GET",p:"/api/v1/dramas/:id/chapters",d:"Chapters",ty:"list",pr:{id:1}},
{m:"GET",p:"/api/v1/dramas/:bookId/episodes/:chapterId",d:"Episode",ty:"video",pr:{bookId:1,chapterId:1}}
]},
reelshort:{n:"ReelShort",l:"/api/v1/foryou",id:"id",t:"name",pa:"data.hall_list",ep:[
{m:"GET",p:"/api/v1/foryou",d:"For You",ty:"list"},
{m:"GET",p:"/api/v1/new",d:"New",ty:"list"},
{m:"GET",p:"/api/v1/completed",d:"Completed",ty:"list"},
{m:"GET",p:"/api/v1/romance",d:"Romance",ty:"list"},
{m:"GET",p:"/api/v1/drama",d:"Drama",ty:"list"},
{m:"GET",p:"/api/v1/leaderboard",d:"Leaderboard",ty:"list"},
{m:"GET",p:"/api/v1/search",d:"Search",ty:"list",q:{q:"Keyword"}},
{m:"GET",p:"/api/v1/feed/:tabId",d:"Feed",ty:"list",pr:{tabId:0}},
{m:"GET",p:"/api/v1/book/:id",d:"Detail",ty:"detail",pr:{id:1}},
{m:"GET",p:"/api/v1/book/:id/chapters",d:"Chapters",ty:"list",pr:{id:1}},
{m:"GET",p:"/api/v1/book/:id/chapter/:chapterId/video",d:"Video",ty:"video",pr:{id:1,chapterId:1}}
]},
shorten:{n:"Shorten",l:"/api/v1/explore",id:"slug",t:"title",pa:"data",ep:[
{m:"GET",p:"/api/v1/editors",d:"Editors",ty:"list"},
{m:"GET",p:"/api/v1/exclusive",d:"Exclusive",ty:"list"},
{m:"GET",p:"/api/v1/dubbed",d:"Dubbed",ty:"list"},
{m:"GET",p:"/api/v1/releases",d:"Releases",ty:"list"},
{m:"GET",p:"/api/v1/categories",d:"Categories",ty:"list"},
{m:"GET",p:"/api/v1/explore",d:"Explore",ty:"list"},
{m:"GET",p:"/api/v1/series/:slug",d:"Series",ty:"detail",pr:{slug:1}}
]},
shortbox:{n:"ShortBox",l:"/api/list",id:"id",t:"name",pa:"data.list",ep:[
{m:"GET",p:"/api/languages",d:"Languages",ty:"meta"},
{m:"GET",p:"/api/categories",d:"Categories",ty:"list"},
{m:"GET",p:"/api/list",d:"List",ty:"list",q:{sort_type:"Sort"}},
{m:"GET",p:"/api/new-list",d:"New",ty:"list"},
{m:"GET",p:"/api/hot-search",d:"Hot",ty:"list"},
{m:"GET",p:"/api/search",d:"Search",ty:"list",q:{keyword:"Keyword"}},
{m:"GET",p:"/api/detail/:id",d:"Detail",ty:"detail",pr:{id:1}},
{m:"GET",p:"/api/episodes/:id",d:"Episodes",ty:"list",pr:{id:1}}
]},
shortmax:{n:"ShortMax",l:"/api/v1/home",id:"code",t:"name",pa:"data",ep:[
{m:"GET",p:"/api/v1/languages",d:"Languages",ty:"meta"},
{m:"GET",p:"/api/v1/home",d:"Home",ty:"list"},
{m:"GET",p:"/api/v1/foryou",d:"For You",ty:"list"},
{m:"GET",p:"/api/v1/feed/recommend",d:"Recommended",ty:"list"},
{m:"GET",p:"/api/v1/feed/new",d:"New",ty:"list"},
{m:"GET",p:"/api/v1/feed/ranked",d:"Ranked",ty:"list"},
{m:"GET",p:"/api/v1/search",d:"Search",ty:"list",q:{q:"Keyword"}},
{m:"GET",p:"/api/v1/detail/:code",d:"Detail",ty:"detail",pr:{code:1}},
{m:"GET",p:"/api/v1/play/:code",d:"Play",ty:"video",pr:{code:1}}
]},
shortsky:{n:"ShortSky",l:"/api/home",id:"id",t:"name",pa:"data",ep:[
{m:"GET",p:"/api/languages",d:"Languages",ty:"meta"},
{m:"GET",p:"/api/home",d:"Home",ty:"list"},
{m:"GET",p:"/api/recommend",d:"Recommended",ty:"list"},
{m:"GET",p:"/api/search",d:"Search",ty:"list",q:{q:"Keyword"}},
{m:"GET",p:"/api/drama/:id",d:"Detail",ty:"detail",pr:{id:1}},
{m:"GET",p:"/api/drama/:id/episode/:ep",d:"Episode",ty:"video",pr:{id:1,ep:1}}
]},
shotshort:{n:"ShotShort",l:"/api/popular",id:"book_id",t:"name",pa:"data",ep:[
{m:"GET",p:"/api/languages",d:"Languages",ty:"meta"},
{m:"GET",p:"/api/popular",d:"Popular",ty:"list"},
{m:"GET",p:"/api/search",d:"Search",ty:"list",q:{q:"Keyword"}},
{m:"GET",p:"/api/category/list",d:"Categories",ty:"list"},
{m:"GET",p:"/api/category",d:"Category",ty:"list",q:{name:"Name"}},
{m:"GET",p:"/api/book/:id",d:"Detail",ty:"detail",pr:{id:1}},
{m:"GET",p:"/api/book/:id/episodes",d:"Episodes",ty:"list",pr:{id:1}},
{m:"GET",p:"/api/book/:bookId/chapter/:chapterId",d:"Chapter",ty:"video",pr:{bookId:1,chapterId:1}}
]},
snackshort:{n:"SnackShort",l:"/api/v1/home",id:"bookId",t:"bookName",pa:"data.data",ep:[
{m:"GET",p:"/api/v1/home",d:"Home",ty:"list"},
{m:"GET",p:"/api/v1/tabs",d:"Tabs",ty:"list"},
{m:"GET",p:"/api/v1/browsing",d:"Browse",ty:"list"},
{m:"GET",p:"/api/v1/search",d:"Search",ty:"list",q:{q:"Keyword"}},
{m:"GET",p:"/api/v1/book/:bookId",d:"Detail",ty:"detail",pr:{bookId:1}},
{m:"GET",p:"/api/v1/book/:bookId/chapters",d:"Chapters",ty:"list",pr:{bookId:1}},
{m:"GET",p:"/api/v1/book/:bookId/episode/:chapterId",d:"Episode",ty:"video",pr:{bookId:1,chapterId:1}}
]},
sodareels:{n:"SodaReels",l:"/api/v1/home",id:"id",t:"title",pa:"data.dinsur.lconne",ep:[
{m:"GET",p:"/api/v1/home",d:"Home",ty:"list"},
{m:"GET",p:"/api/v1/search",d:"Search",ty:"list",q:{q:"Keyword"}},
{m:"GET",p:"/api/v1/category",d:"Categories",ty:"list"},
{m:"GET",p:"/api/v1/info/:id",d:"Info",ty:"detail",pr:{id:1}},
{m:"GET",p:"/api/v1/drama/:id",d:"Drama",ty:"detail",pr:{id:1}},
{m:"GET",p:"/api/v1/episodes",d:"Episodes",ty:"list",q:{id:"Drama ID"}}
]},
stardusttv:{n:"StardustTV",l:"/api/v1/homepage",id:"id",t:"name",pa:"data",ep:[
{m:"GET",p:"/api/v1/languages",d:"Languages",ty:"meta"},
{m:"GET",p:"/api/v1/homepage",d:"Homepage",ty:"list"},
{m:"GET",p:"/api/v1/search",d:"Search",ty:"list",q:{q:"Keyword"}},
{m:"GET",p:"/api/v1/video/:slug/:id",d:"Detail",ty:"detail",pr:{slug:1,id:1}},
{m:"GET",p:"/api/v1/video/:slug/:id/episode/:episode",d:"Episode",ty:"video",pr:{slug:1,id:1,episode:1}}
]},
starshort:{n:"StarShort",l:"/api/v1/dramas",id:"id",t:"title",pa:"data",ep:[
{m:"GET",p:"/api/v1/languages",d:"Languages",ty:"meta"},
{m:"GET",p:"/api/v1/dramas",d:"Popular",ty:"list"},
{m:"GET",p:"/api/v1/dramas/new",d:"New",ty:"list"},
{m:"GET",p:"/api/v1/dramas/search",d:"Search",ty:"list",q:{q:"Keyword"}},
{m:"GET",p:"/api/v1/dramas/:dramaId",d:"Detail",ty:"detail",pr:{dramaId:1}},
{m:"GET",p:"/api/v1/dramas/:dramaId/episodes",d:"Episodes",ty:"list",pr:{dramaId:1}},
{m:"GET",p:"/api/v1/dramas/:dramaId/episodes/:epNum",d:"Episode",ty:"video",pr:{dramaId:1,epNum:1}}
]},
velolo:{n:"Velolo",l:"/hot",id:"id",t:"name",pa:"data",ep:[
{m:"GET",p:"/languages",d:"Languages",ty:"meta"},
{m:"GET",p:"/hot",d:"Hot",ty:"list"},
{m:"GET",p:"/new",d:"New",ty:"list"},
{m:"GET",p:"/labels",d:"Labels",ty:"list"},
{m:"GET",p:"/dramas",d:"Dramas",ty:"list",q:{keyword:"Search",labelId:"Label"}},
{m:"GET",p:"/detail/:id",d:"Detail",ty:"detail",pr:{id:1}}
]},
vigloo:{n:"Vigloo",l:"/api/v1/tabs",id:"id",t:"name",pa:"data",ep:[
{m:"GET",p:"/api/v1/languages",d:"Languages",ty:"meta"},
{m:"GET",p:"/api/v1/tabs",d:"Tabs",ty:"list"},
{m:"GET",p:"/api/v1/tabs/:id",d:"Tab",ty:"list",pr:{id:0}},
{m:"GET",p:"/api/v1/browse",d:"Browse",ty:"list"},
{m:"GET",p:"/api/v1/search",d:"Search",ty:"list",q:{q:"Keyword"}},
{m:"GET",p:"/api/v1/rank",d:"Ranking",ty:"list"},
{m:"GET",p:"/api/v1/genres",d:"Genres",ty:"list"},
{m:"GET",p:"/api/v1/drama/:id",d:"Detail",ty:"detail",pr:{id:1}},
{m:"GET",p:"/api/v1/drama/:programId/season/:seasonId/episodes",d:"Episodes",ty:"list",pr:{programId:1,seasonId:1}},
{m:"GET",p:"/api/v1/play",d:"Play",ty:"video",q:{id:"Video ID"}}
]}
};

var getToken=function(){return document.getElementById('tokenInput').value||localStorage.getItem('sapimu_token')||''};
var extractParams=function(p){return(p.match(/:(\w+)/g)||[]).map(function(m){return m.slice(1)})};

function saveToken(){
  var t=document.getElementById('tokenInput').value.trim();
  if(!t)return alert('Enter token!');
  localStorage.setItem('sapimu_token',t);
  document.getElementById('tokenDot').className='token-dot active';
  document.getElementById('tokenStatusText').textContent='Active';
  document.getElementById('tokenStatusText').style.color='var(--green)';
  cache={ids:{},chapters:{}};localStorage.removeItem(CACHE_KEY);
  prefetchAll();
}

function loadToken(){
  var s=localStorage.getItem('sapimu_token')||TOKEN_DEFAULT;
  document.getElementById('tokenInput').value=s;
  if(s){
    document.getElementById('tokenDot').className='token-dot active';
    document.getElementById('tokenStatusText').textContent='Active';
    document.getElementById('tokenStatusText').style.color='var(--green)';
    localStorage.setItem('sapimu_token',s);
  }
}

// ============================================
// FETCH WITH DEBUG INFO
// ============================================
async function fetchPlatformIds(k){
  var pl=P[k];if(!pl.l)return[];
  if(cache.ids[k]&&cache.ids[k].length)return cache.ids[k];
  var token=getToken();
  var url=makeUrl(k+pl.l,{});

  for(var attempt=0;attempt<3;attempt++){
    try{
      var r=await fetch(url,{headers:{'Authorization':'Bearer '+token}});
      var txt=await r.text();
      
      // Debug: log raw response
      console.log(k+' ['+r.status+'] size:'+txt.length);
      
      if(!r.ok){
        console.warn(k+' error response:', txt.substring(0,200));
        failedErrors[k]='HTTP '+r.status;
        if(attempt<2){await wait(3000*(attempt+1));continue;}
        return[];
      }
      
      var j;
      try{j=JSON.parse(txt);}catch(pe){
        console.warn(k+' JSON parse error:', txt.substring(0,200));
        failedErrors[k]='Invalid JSON';
        if(attempt<2){await wait(3000*(attempt+1));continue;}
        return[];
      }
      
      // Check if proxy returned error
      if(j.proxy_error){
        console.warn(k+' proxy error:', j);
        failedErrors[k]='Proxy: '+j.status+' '+(j.body||'').substring(0,100);
        if(attempt<2){await wait(3000*(attempt+1));continue;}
        return[];
      }
      
      var d=j;
      if(pl.pa){var parts=pl.pa.split('.');for(var pi=0;pi<parts.length;pi++){d=d?d[parts[pi]]:undefined;}}
      if(!Array.isArray(d)){
        if(d&&d.list)d=d.list;
        else if(d&&d.dramas)d=d.dramas;
        else if(d&&d.items)d=d.items;
        else if(d&&d.hall_list)d=d.hall_list;
        else if(d&&typeof d==='object'){var vals=Object.values(d);d=Array.isArray(vals[0])?vals[0]:[];}
        else d=[];
      }
      if(!Array.isArray(d))d=[];

      var items=d.slice(0,50).map(function(i){return{
        id:String(i[pl.id]||i.id||i.book_id||i.bookId||i.code||i.playlet_id||i.dcup||''),
        t:(i[pl.t]||i.title||i.name||i.bookName||'Unknown').substring(0,40)
      }}).filter(function(x){return x.id});

      if(items.length===0){
        failedErrors[k]='0 items parsed from response';
        console.warn(k+' 0 items. Response keys:', Object.keys(j));
      }
      
      cache.ids[k]=items;return items;
    }catch(e){
      console.error(k+' attempt '+(attempt+1)+' error:', e.message);
      failedErrors[k]=e.message;
      if(attempt<2)await wait(3000*(attempt+1));
    }
  }
  return[];
}

// ============================================
// SEQUENTIAL FETCH
// ============================================
async function prefetchAll(){
  var token=getToken();if(!token)return;
  var keys=Object.keys(P);
  var total=keys.length;
  var done=0,success=0;
  failedPlatforms=[];
  failedErrors={};

  document.getElementById('loadingBar').classList.add('show');
  document.getElementById('prefetchStatus').className='prefetch-status loading';

  for(var ki=0;ki<keys.length;ki++){
    var k=keys[ki];
    done++;
    document.getElementById('prefetchStatus').textContent='['+done+'/'+total+'] Loading '+P[k].n+'...';
    document.getElementById('loadingProgress').style.width=Math.round((done/total)*100)+'%';

    try{
      var items=await fetchPlatformIds(k);
      if(items.length>0){success++;saveCache();}
      else failedPlatforms.push(k);
    }catch(e){failedPlatforms.push(k);}

    updateNavStatus(k);
    await wait(2000);
  }

  document.getElementById('loadingBar').classList.remove('show');
  finishPrefetch(success,total);
  populateAllDropdowns();
}

function updateNavStatus(k){
  var nav=document.querySelector('.nav-item[data-key="'+k+'"]');if(!nav)return;
  var old=nav.querySelector('.nav-status');if(old)old.remove();
  var span=document.createElement('span');span.className='nav-status';
  if(cache.ids[k]&&cache.ids[k].length){span.textContent='‚úì'+cache.ids[k].length;span.style.color='var(--green)';}
  else{span.textContent='‚úó';span.style.color='var(--red)';}
  nav.appendChild(span);
}

function finishPrefetch(success,total){
  var totalIds=0;Object.values(cache.ids).forEach(function(a){totalIds+=a.length});
  if(!failedPlatforms.length){
    document.getElementById('prefetchStatus').className='prefetch-status done';
    document.getElementById('prefetchStatus').textContent='‚úì All '+total+' loaded! ('+totalIds+' IDs)';
  }else{
    // Show error details
    var errorDetails=failedPlatforms.map(function(k){
      return P[k].n+': '+(failedErrors[k]||'unknown');
    }).join('\n');
    console.error('Failed platforms:\n'+errorDetails);
    
    document.getElementById('prefetchStatus').className='prefetch-status error';
    document.getElementById('prefetchStatus').innerHTML='‚ö† '+success+'/'+total+' loaded ('+totalIds+' IDs). <button onclick="retryFailed()" style="background:var(--yellow);color:#000;border:none;padding:4px 12px;border-radius:4px;cursor:pointer;font-weight:600">üîÑ Retry '+failedPlatforms.length+'</button> <button onclick="showErrors()" style="background:var(--bg3);color:var(--text);border:1px solid var(--border);padding:4px 12px;border-radius:4px;cursor:pointer">üîç Show Errors</button><br><small style="color:var(--text3)">Failed: '+failedPlatforms.map(function(k){return P[k].n}).join(', ')+'</small><pre id="errorLog" style="display:none;margin-top:8px;font-size:10px;color:var(--red);max-height:200px;overflow:auto">'+errorDetails+'</pre>';
  }
}

function showErrors(){
  var el=document.getElementById('errorLog');
  if(el)el.style.display=el.style.display==='none'?'block':'none';
}

async function retryFailed(){
  if(!failedPlatforms.length)return;
  var toRetry=failedPlatforms.slice();failedPlatforms=[];var success=0;
  document.getElementById('prefetchStatus').className='prefetch-status loading';
  for(var i=0;i<toRetry.length;i++){
    var k=toRetry[i];
    document.getElementById('prefetchStatus').textContent='Retrying ['+(i+1)+'/'+toRetry.length+'] '+P[k].n+'...';
    delete cache.ids[k];delete failedErrors[k];
    try{var items=await fetchPlatformIds(k);if(items.length>0){success++;saveCache();}else failedPlatforms.push(k);}
    catch(e){failedPlatforms.push(k);}
    updateNavStatus(k);
    await wait(3000);
  }
  var loaded=Object.keys(cache.ids).filter(function(k){return cache.ids[k]&&cache.ids[k].length}).length;
  finishPrefetch(loaded,Object.keys(P).length);populateAllDropdowns();
}

function populateAllDropdowns(){
  Object.keys(P).forEach(function(k){
    var items=cache.ids[k]||[];
    P[k].ep.forEach(function(ep,i){
      extractParams(ep.p).forEach(function(pr){
        if(ep.pr&&ep.pr[pr]===1){
          var sel=document.getElementById('sel-'+k+'-'+i+'-'+pr);
          if(sel){
            if(items.length>0){
              sel.innerHTML='<option value="">-- Select ('+items.length+') --</option>'+items.map(function(d){return'<option value="'+d.id+'">'+d.id+' - '+d.t+'</option>'}).join('');
              sel.classList.add('loaded');sel.classList.remove('error');
            }else{sel.innerHTML='<option value="">-- No data --</option>';sel.classList.add('error');}
          }
        }
      });
    });
  });
}

// ============================================
// URL
// ============================================
function getApiPath(k,i){
  var ep=P[k].ep[i];var p=ep.p;
  extractParams(p).forEach(function(pr){
    var sel=document.getElementById('sel-'+k+'-'+i+'-'+pr);
    var inp=document.getElementById('inp-'+k+'-'+i+'-'+pr);
    var v=(sel&&sel.value)||(inp&&inp.value&&inp.value.trim())||'';
    if(v)p=p.replace(':'+pr,encodeURIComponent(v));
  });
  return p;
}
function getQueryParams(k,i){
  var ep=P[k].ep[i];var params={};
  if(ep.ty==='list'){
    var page=document.getElementById('q-'+k+'-'+i+'-page');if(page&&page.value)params.page=page.value;
    var limit=document.getElementById('q-'+k+'-'+i+'-limit');if(limit&&limit.value)params.limit=limit.value;
    var lang=document.getElementById('q-'+k+'-'+i+'-lang');if(lang&&lang.value)params.lang=lang.value;
  }
  if(ep.q){Object.keys(ep.q).forEach(function(qk){if(['page','limit','lang'].indexOf(qk)!==-1)return;var el=document.getElementById('q-'+k+'-'+i+'-'+qk);if(el&&el.value&&el.value.trim())params[qk]=el.value.trim();});}
  return params;
}
function buildFetchUrl(k,i){return makeUrl(k+getApiPath(k,i),getQueryParams(k,i))}
function buildDisplayUrl(k,i){return directUrl(k+getApiPath(k,i),getQueryParams(k,i))}
function updateUrl(k,i){var el=document.getElementById('url-'+k+'-'+i);if(el)el.value=buildDisplayUrl(k,i);}
function changePage(k,i,delta){var inp=document.getElementById('q-'+k+'-'+i+'-page');if(!inp)return;var v=parseInt(inp.value)||1;v+=delta;if(v<1)v=1;inp.value=v;updateUrl(k,i);}

// ============================================
// RENDER
// ============================================
var totalEp=0;Object.values(P).forEach(function(p){totalEp+=p.ep.length});

function renderSidebar(){
  var nav=document.getElementById('sidebarNav');
  var sorted=Object.entries(P).sort(function(a,b){return a[1].n.localeCompare(b[1].n)});
  nav.innerHTML=sorted.map(function(e){var k=e[0],p=e[1];return'<div class="nav-item" data-key="'+k+'" onclick="scrollTo(\''+k+'\')"><div class="nav-icon">'+p.n.slice(0,2).toUpperCase()+'</div><div class="nav-name">'+p.n+'</div><div class="nav-count">'+p.ep.length+'</div></div>'}).join('');
}
function hl(p){return p.replace(/:(\w+)/g,'<span class="param">:$1</span>')}

function renderContent(){
  var content=document.getElementById('content');
  var sorted=Object.entries(P).sort(function(a,b){return a[1].n.localeCompare(b[1].n)});
  var html=sorted.map(function(e){
    var k=e[0],pl=e[1];
    var eps=pl.ep.map(function(ep,i){
      var prs=extractParams(ep.p);var isList=ep.ty==='list';
      var paramHtml='<div class="param-grid">';
      if(isList){paramHtml+='<div class="param-item"><label>page <span class="opt">(opt)</span></label><div class="page-ctrl"><button onclick="changePage(\''+k+'\','+i+',-1)">‚àí</button><input type="number" id="q-'+k+'-'+i+'-page" value="1" min="1" oninput="updateUrl(\''+k+'\','+i+')"><button onclick="changePage(\''+k+'\','+i+',1)">+</button></div></div><div class="param-item"><label>limit <span class="opt">(opt)</span></label><input type="number" id="q-'+k+'-'+i+'-limit" value="20" oninput="updateUrl(\''+k+'\','+i+')"></div><div class="param-item"><label>lang <span class="opt">(opt)</span></label><select id="q-'+k+'-'+i+'-lang" onchange="updateUrl(\''+k+'\','+i+')"><option value="">Auto</option>'+LANGS.map(function(l){return'<option value="'+l.c+'"'+(l.c==='id'?' selected':'')+'>'+l.n+'</option>'}).join('')+'</select></div>';}
      if(prs.length>0){prs.forEach(function(pr){if(ep.pr&&ep.pr[pr]===0){paramHtml+='<div class="param-item"><label>'+pr+' <span class="req">*</span></label><input type="text" id="inp-'+k+'-'+i+'-'+pr+'" placeholder="'+pr+'" oninput="updateUrl(\''+k+'\','+i+')" value="'+(pr==='page'?'1':'')+'"></div>';}else{paramHtml+='<div class="param-item"><label>'+pr+' <span class="req">*</span></label><select id="sel-'+k+'-'+i+'-'+pr+'" onchange="updateUrl(\''+k+'\','+i+')"><option value="">Loading...</option></select><input type="text" id="inp-'+k+'-'+i+'-'+pr+'" placeholder="Or type ID" oninput="updateUrl(\''+k+'\','+i+')" style="margin-top:4px;font-size:10px"></div>';}});}
      if(ep.q){Object.entries(ep.q).forEach(function(qe){var qk=qe[0],qd=qe[1];if(isList&&['page','limit','lang'].indexOf(qk)!==-1)return;paramHtml+='<div class="param-item"><label>'+qk+' <span class="opt">(query)</span></label><input type="text" id="q-'+k+'-'+i+'-'+qk+'" placeholder="'+qd+'" oninput="updateUrl(\''+k+'\','+i+')"></div>';});}
      paramHtml+='</div>';
      var defUrl=directUrl(k+ep.p,{});
      return '<div class="endpoint-card" id="'+k+'-'+i+'"><div class="endpoint-header" onclick="toggle(\''+k+'-'+i+'\')"><span class="method-badge method-'+ep.m+'">'+ep.m+'</span><span class="endpoint-path">'+hl(ep.p)+'</span><span class="endpoint-desc">'+ep.d+'</span><span class="endpoint-toggle">‚ñº</span></div><div class="endpoint-detail"><div class="detail-section"><h4>Parameters</h4>'+paramHtml+'</div><div class="try-section"><div class="try-url"><input type="text" value="'+defUrl+'" id="url-'+k+'-'+i+'" readonly><button class="btn-copy" onclick="copy(\'url-'+k+'-'+i+'\')">üìã</button><button class="btn-curl" onclick="copyCurl(\''+k+'\','+i+')">cURL</button><button class="btn-send" onclick="send(\''+k+'\','+i+')">‚ñ∂ Send</button></div><div class="response-box" id="resp-'+k+'-'+i+'"><div class="response-header"><span class="response-status" id="rs-'+k+'-'+i+'"></span><div class="response-actions"><span id="rz-'+k+'-'+i+'"></span><button onclick="copy(\'rb-'+k+'-'+i+'\')">üìã</button><button onclick="document.getElementById(\'resp-'+k+'-'+i+'\').style.display=\'none\'">‚úï</button></div></div><pre class="response-body" id="rb-'+k+'-'+i+'"></pre></div></div></div></div>';
    }).join('');
    return '<div class="platform-section" id="p-'+k+'"><div class="platform-header"><div class="platform-icon">'+pl.n.slice(0,2).toUpperCase()+'</div><div><h2>'+pl.n+'</h2><div class="platform-meta">Base: <code>/'+k+'</code> ¬∑ '+pl.ep.length+' endpoints</div></div></div>'+eps+'</div>';
  }).join('');
  content.innerHTML=html;
}

function toggle(id){document.getElementById(id).classList.toggle('open')}
function scrollTo(k){document.getElementById('p-'+k).scrollIntoView({behavior:'smooth'});document.querySelectorAll('.nav-item').forEach(function(n){n.classList.remove('active')});var el=document.querySelector('.nav-item[data-key="'+k+'"]');if(el)el.classList.add('active');if(window.innerWidth<768)toggleSidebar();}
function filterPlatforms(){var q=document.getElementById('searchInput').value.toLowerCase();document.querySelectorAll('.nav-item').forEach(function(n){n.style.display=n.querySelector('.nav-name').textContent.toLowerCase().indexOf(q)!==-1?'flex':'none'});document.querySelectorAll('.platform-section').forEach(function(s){s.style.display=s.querySelector('h2').textContent.toLowerCase().indexOf(q)!==-1?'block':'none'});}
function toggleSidebar(){document.getElementById('sidebar').classList.toggle('open');document.getElementById('overlay').classList.toggle('show')}
function copy(id){var el=document.getElementById(id);navigator.clipboard.writeText(el.value||el.textContent)}
function copyCurl(k,i){navigator.clipboard.writeText('curl "'+buildDisplayUrl(k,i)+'" -H "Authorization: Bearer '+getToken()+'"');alert('Copied!')}

async function send(k,i){
  var t=getToken();if(!t)return alert('Set token first!');
  var url=buildFetchUrl(k,i);var ep=P[k].ep[i];
  var box=document.getElementById('resp-'+k+'-'+i);
  var st=document.getElementById('rs-'+k+'-'+i);
  var sz=document.getElementById('rz-'+k+'-'+i);
  var bd=document.getElementById('rb-'+k+'-'+i);
  box.style.display='block';st.textContent='‚è≥ Loading...';st.className='response-status loading';bd.textContent='';
  try{
    var r=await fetch(url,{method:ep.m,headers:{Authorization:'Bearer '+t}});
    var txt=await r.text();
    st.textContent=r.status+' '+r.statusText;st.className='response-status '+(r.ok?'ok':'err');
    sz.textContent=(txt.length/1024).toFixed(1)+'KB';
    try{bd.textContent=JSON.stringify(JSON.parse(txt),null,2)}catch(e2){bd.textContent=txt}
  }catch(e){st.textContent='‚ùå Error';st.className='response-status err';bd.textContent='Error: '+e.message;}
}

// INIT
document.getElementById('statPlatforms').textContent=Object.keys(P).length;
document.getElementById('statEndpoints').textContent=totalEp;
document.getElementById('badgePlatforms').textContent=Object.keys(P).length;
document.getElementById('badgeEndpoints').textContent=totalEp;
loadCache();renderSidebar();renderContent();loadToken();

async function init(){
  if(!isLocal){
    try{
      var r=await fetch('/api/proxy');
      var j=await r.json();
      if(j.status!=='ok'){document.getElementById('prefetchStatus').className='prefetch-status error';document.getElementById('prefetchStatus').textContent='‚ùå Proxy error';return;}
    }catch(e){document.getElementById('prefetchStatus').className='prefetch-status error';document.getElementById('prefetchStatus').textContent='‚ùå Proxy not found: '+e.message;return;}
  }
  var cached=Object.keys(cache.ids).filter(function(k){return cache.ids[k]&&cache.ids[k].length}).length;
  if(cached>0){
    populateAllDropdowns();Object.keys(cache.ids).forEach(function(k){updateNavStatus(k)});
    var totalIds=0;Object.values(cache.ids).forEach(function(a){totalIds+=a.length});
    if(cached>=Object.keys(P).length){document.getElementById('prefetchStatus').className='prefetch-status done';document.getElementById('prefetchStatus').textContent='‚úì Cache loaded! ('+totalIds+' IDs, '+cached+' platforms)';}
    else{document.getElementById('prefetchStatus').className='prefetch-status done';document.getElementById('prefetchStatus').innerHTML='‚úì Cache: '+cached+'/'+Object.keys(P).length+' ('+totalIds+' IDs). <button onclick="prefetchAll()" style="background:var(--accent);color:#fff;border:none;padding:4px 12px;border-radius:4px;cursor:pointer">Load remaining</button>';}
  }else if(getToken()){setTimeout(prefetchAll,300);}
}
init();
</script>
